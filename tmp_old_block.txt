function HermeneuticsView({ userData, setUserData }) {
  const [selectedLevel, setSelectedLevel] = useState("beginner"); // beginner | intermediate | advanced
  const [selectedLesson, setSelectedLesson] = useState(null);
  const [lessonContent, setLessonContent] = useState("");
  const [loading, setLoading] = useState(false);
  const [showFullText, setShowFullText] = useState(false);
  const [goalChecks, setGoalChecks] = useState([]);
  const [practiceResponses, setPracticeResponses] = useState({});
  const [quizResponses, setQuizResponses] = useState({});
  const [practiceSaved, setPracticeSaved] = useState(false);
  const [quizSaved, setQuizSaved] = useState(false);

  // Import the hermeneutics course data
  const courseData = {
    beginner: {
      title: "Beginner Hermeneutics",
      description: "Foundational principles of biblical interpretation covering context, grammar, historical setting, cultural background, and theological significance.",
      totalLessons: 100,
      badge: "beginner_badge.png",
      lessonPath: "hermeneutics_beginner_100_lessons",
      lessonPrefix: "Lesson_"
    },
    intermediate: {
      title: "Intermediate Hermeneutics",
      description: "Develop deeper interpretive skills with historical-cultural analysis, genre nuance, intertextuality, theological synthesis, and literary devices.",
      totalLessons: 100,
      badge: "intermediate_badge.png",
      lessonPath: "hermeneutics_intermediate_100_lessons",
      lessonPrefix: "Intermediate_Lesson_"
    },
    advanced: {
      title: "Advanced Hermeneutics",
      description: "Master high-level interpretive frameworks including discourse analysis, advanced syntax, canonical theology, typological systems, and apocalyptic symbolism.",
      totalLessons: 100,
      badge: "advanced_badge.png",
      lessonPath: "hermeneutics_advanced_100_lessons",
      lessonPrefix: "Advanced_Lesson_"
    }
  };

  const currentCourse = courseData[selectedLevel];
  const parsedLesson = useMemo(() => parseHermeneuticsLessonContent(lessonContent), [lessonContent]);

  useEffect(() => {
    setGoalChecks(Array(parsedLesson.goals.length).fill(false));
    setPracticeResponses({});
    setQuizResponses({});
    setPracticeSaved(false);
    setQuizSaved(false);
  }, [parsedLesson.goals.length, parsedLesson.practice.length, parsedLesson.quiz.length, parsedLesson.title, lessonContent]);

  const toggleGoal = (index) => {
    setGoalChecks(prev => {
      const next = [...prev];
      next[index] = !next[index];
      return next;
    });
  };

  const handlePracticeChange = (index, value) => {
    setPracticeResponses(prev => ({ ...prev, [index]: value }));
  };

  const handleQuizChange = (index, value) => {
    setQuizResponses(prev => ({ ...prev, [index]: value }));
  };

  const handlePracticeSave = () => {
    setPracticeSaved(true);
    setTimeout(() => setPracticeSaved(false), 1800);
  };

  const handleQuizSave = () => {
    setQuizSaved(true);
    setTimeout(() => setQuizSaved(false), 1800);
  };
  const progress = userData.hermeneuticsProgress?.[selectedLevel] || { completedLessons: [], quizScores: {} };
  const completedCount = progress.completedLessons?.length || 0;
  const progressPercent = Math.round((completedCount / currentCourse.totalLessons) * 100);
  const hasBadge = completedCount >= currentCourse.totalLessons;
  const highlightedParagraphs = parsedLesson.content.slice(0, 3);

  // Load lesson content
  const loadLesson = async (lessonNumber) => {
    setLoading(true);
    setSelectedLesson(lessonNumber);

    try {
      const paddedNumber = String(lessonNumber).padStart(3, '0');
      const fileName = `${currentCourse.lessonPrefix}${paddedNumber}.txt`;
      const publicUrl = process.env.PUBLIC_URL || "";
      const normalizedBase = publicUrl.endsWith("/") ? publicUrl.slice(0, -1) : publicUrl;
      const lessonPath = `${normalizedBase}/data/${currentCourse.lessonPath}/${fileName}`;
      const response = await fetch(lessonPath);

      if (!response.ok) {
        throw new Error(`Failed to load ${lessonPath} (${response.status})`);
      }

      const text = await response.text();
      setLessonContent(text);
    } catch (error) {
      console.error("Hermeneutics lesson load error:", error);
      setLessonContent("Lesson content could not be loaded. Please check your network or try again later.");
    } finally {
      setLoading(false);
    }
  };

  // Mark lesson as completed
  const markLessonComplete = () => {
    if (!selectedLesson) return;

    const newProgress = { ...userData.hermeneuticsProgress };
    if (!newProgress[selectedLevel]) {
      newProgress[selectedLevel] = { completedLessons: [], quizScores: {} };
    }

    if (!newProgress[selectedLevel].completedLessons.includes(selectedLesson)) {
      newProgress[selectedLevel].completedLessons.push(selectedLesson);
      setUserData({ ...userData, hermeneuticsProgress: newProgress });
    }

    // Move to next lesson
    if (selectedLesson < currentCourse.totalLessons) {
      loadLesson(selectedLesson + 1);
    }
  };

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="rounded-2xl border border-amber-500/20 bg-slate-800/40 p-6">
        <h2 className="text-2xl font-bold mb-4 flex items-center gap-2">
          <NotebookPen className="text-amber-400" />
          Hermeneutics Courses
        </h2>
        <p className="text-slate-300">
          Master biblical interpretation through comprehensive courses covering foundational to advanced hermeneutical principles.
          Complete all 100 lessons in each level to earn certification badges.
        </p>
      </div>

      {/* Level Selection */}
      <div className="grid md:grid-cols-3 gap-4">
        {Object.entries(courseData).map(([level, course]) => {
          const levelProgress = userData.hermeneuticsProgress?.[level] || { completedLessons: [] };
          const levelCompleted = levelProgress.completedLessons?.length || 0;
          const levelPercent = Math.round((levelCompleted / course.totalLessons) * 100);
          const hasCertification = levelCompleted >= course.totalLessons;

          return (
            <button
              key={level}
              className={`rounded-xl border p-4 text-left transition-all ${
                selectedLevel === level
                  ? "border-amber-500 bg-amber-500/10"
                  : "border-amber-500/20 bg-slate-800/40 hover:bg-slate-800/60"
              }`}
              onClick={() => setSelectedLevel(level)}
            >
              <div className="font-bold text-lg mb-2 capitalize">{level}</div>
              <div className="text-sm text-slate-400 mb-3">{course.description}</div>
              <div className="flex items-center gap-2 mb-2">
                <div className="flex-1 bg-slate-700 rounded-full h-2">
                  <div className="bg-amber-500 h-2 rounded-full transition-all" style={{ width: `${levelPercent}%` }} />
                </div>
                <span className="text-sm text-amber-400">{levelPercent}%</span>
              </div>
              <div className="text-xs text-slate-400">
                {levelCompleted} / {course.totalLessons} lessons completed
              </div>
              {hasCertification && (
                <div className="mt-3 flex items-center gap-2 text-amber-400">
                  <Trophy size={16} />
                  <span className="text-sm font-semibold">Certified</span>
                </div>
              )}
            </button>
          );
        })}
      </div>

      {/* Badge Display */}
      {hasBadge && (
        <div className="rounded-2xl border border-amber-500/20 bg-slate-800/40 p-6 text-center">
          <Trophy className="text-amber-400 mx-auto mb-3" size={48} />
          <h3 className="text-xl font-bold mb-2">Certification Earned!</h3>
          <p className="text-slate-300 mb-4">
            Congratulations! You've completed all {currentCourse.totalLessons} lessons in {currentCourse.title}.
          </p>
          <img
            src={`/${currentCourse.badge}`}
            alt={`${currentCourse.title} Badge`}
            className="mx-auto w-32 h-32"
          />
        </div>
      )}

      {/* Lesson Grid */}
      <div className="rounded-2xl border border-amber-500/20 bg-slate-800/40 p-6">
        <h3 className="text-xl font-bold mb-4">{currentCourse.title}</h3>
        <p className="text-slate-300 mb-4">{currentCourse.description}</p>

        <div className="grid grid-cols-5 sm:grid-cols-10 gap-2">
          {Array.from({ length: currentCourse.totalLessons }, (_, i) => i + 1).map(lessonNum => {
            const isCompleted = progress.completedLessons?.includes(lessonNum);
            const isSelected = selectedLesson === lessonNum;

            return (
              <button
                key={lessonNum}
                className={`p-2 rounded-lg text-sm font-semibold transition-all ${
                  isSelected
                    ? "bg-amber-500 text-slate-900"
                    : isCompleted
                    ? "bg-green-600/50 text-white hover:bg-green-600/70"
                    : "bg-slate-700 text-slate-300 hover:bg-slate-600"
                }`}
                onClick={() => loadLesson(lessonNum)}
              >
                {lessonNum}
              </button>
            );
          })}
        </div>
      </div>

      {/* Lesson Content */}
      {selectedLesson && (
        <div className="rounded-2xl border border-amber-500/20 bg-slate-800/40 p-6">
          <div className="flex items-center justify-between mb-4">
            <h3 className="text-xl font-bold">
              Lesson {selectedLesson} - {currentCourse.title}
            </h3>
            <button
              className="btn-secondary"
              onClick={() => setSelectedLesson(null)}
            >
              Close Lesson
            </button>
          </div>

          {loading ? (
            <div className="text-center py-12 text-slate-400">Loading lesson...</div>
          ) : (
            <>
              <div className="space-y-4 mb-6">
                {highlightedParagraphs.length > 0 ? (
                  highlightedParagraphs.map((paragraph, idx) => (
                    <p key={`lesson-p-${idx}`} className="text-sm text-slate-200 leading-relaxed">
                      {paragraph}
                    </p>
                  ))
                ) : (
                  <p className="text-sm text-slate-400">
                    This lesson will load once you select it from the grid above.
                  </p>
                )}
              </div>
              <div className="flex items-center gap-3 mb-6">
                <button
                  className="btn btn-sm"
                  onClick={() => setShowFullText(prev => !prev)}
                >
                  {showFullText ? "Hide full lesson text" : "View full lesson text"}
                </button>
                {showFullText && (
                  <span className="text-xs text-slate-400">
                    {parsedLesson.content.length} paragraph{parsedLesson.content.length === 1 ? "" : "s"}
                  </span>
                )}
              </div>
              {showFullText && parsedLesson.content.length > 0 && (
                <div className="rounded-2xl border border-slate-700 bg-slate-900/70 p-4 mb-6 space-y-3">
                  {parsedLesson.content.map((paragraph, idx) => (
                    <p key={`full-${idx}`} className="text-sm text-slate-200 leading-relaxed">
                      {paragraph}
                    </p>
                  ))}
                </div>
              )}

              {!showFullText && (
                <div className="rounded-2xl border border-slate-700 bg-slate-900/50 p-4 mb-6">
                  <p className="text-xs uppercase tracking-[0.3em] text-slate-500">
                    Previewed content above is trimmed to keep the interface concise.
                  </p>
                </div>
              )}
              {parsedLesson.title && (
                <div className="mb-4 text-xs font-semibold uppercase tracking-[0.4em] text-amber-300">
                  {parsedLesson.title}
                </div>
              )}

              {parsedLesson.goals.length > 0 && (
                <div className="rounded-2xl border border-slate-700 bg-slate-900/60 p-4 mb-4">
                  <h4 className="text-base font-semibold text-amber-200 mb-3">Learning Goals</h4>
                  <div className="grid gap-2 md:grid-cols-2">
                    {parsedLesson.goals.map((goal, idx) => (
                      <label
                        key={`goal-${idx}`}
                        className={`flex cursor-pointer items-center gap-3 rounded-xl border px-3 py-2 text-sm transition ${
                          goalChecks[idx]
                            ? "border-emerald-400 bg-emerald-500/10 text-emerald-200"
                            : "border-slate-700 bg-slate-900/50 text-slate-300 hover:border-slate-500"
                        }`}
                      >
                        <input
                          type="checkbox"
                          checked={goalChecks[idx] || false}
                          onChange={() => toggleGoal(idx)}
                          className="h-4 w-4 rounded border-slate-600 bg-slate-800 text-amber-400 focus:ring-amber-400"
                        />
                        <span>{goal}</span>
                      </label>
                    ))}
                  </div>
                </div>
              )}

              {parsedLesson.examples.length > 0 && (
                <div className="rounded-2xl border border-slate-700 bg-slate-900/60 p-4 mb-4">
                  <h4 className="text-base font-semibold text-amber-200 mb-3">Examples in this lesson</h4>
                  <div className="space-y-3 text-sm text-slate-300">
                    {parsedLesson.examples.map((example, idx) => (
                      <div key={`example-${idx}`} className="flex items-start gap-3">
                        <span className="text-amber-400 text-lg leading-none">â€¢</span>
                        <p>{example}</p>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {parsedLesson.practice.length > 0 && (
                <div className="rounded-2xl border border-slate-700 bg-slate-900/60 p-4 mb-4">
                  <div className="flex items-center gap-2 mb-3">
                    <BookOpen className="text-amber-400" size={18} />
                    <h4 className="text-base font-semibold text-amber-200">Practice Activities</h4>
                  </div>
                  <div className="space-y-4">
                    {parsedLesson.practice.map((task, idx) => (
                      <div key={`practice-${idx}`} className="space-y-2">
                        <p className="font-semibold text-slate-200">{task}</p>
                        <textarea
                          placeholder="Type your reflection or observations..."
                          value={practiceResponses[idx] || ""}
                          onChange={(event) => handlePracticeChange(idx, event.target.value)}
                          className="w-full rounded-xl border border-slate-700 bg-slate-900/80 px-3 py-2 text-sm text-slate-100 focus:border-amber-500 focus:outline-none"
                          rows={2}
                        />
                      </div>
                    ))}
                  </div>
                  <div className="mt-4 flex items-center gap-3">
                    <button type="button" className="btn" onClick={handlePracticeSave}>
                      Save Practice Notes
                    </button>
                    {practiceSaved && <span className="text-sm text-emerald-300">Notes saved locally.</span>}
                  </div>
                </div>
              )}

              {parsedLesson.quiz.length > 0 && (
                <div className="rounded-2xl border border-slate-700 bg-slate-900/60 p-4 mb-4">
                  <div className="flex items-center gap-2 mb-3">
                    <Feather className="text-amber-400" size={18} />
                    <h4 className="text-base font-semibold text-amber-200">Quiz It</h4>
                  </div>
                  <div className="space-y-4 text-sm text-slate-300">
                    {parsedLesson.quiz.map((question, idx) => (
                      <div key={`quiz-${idx}`} className="space-y-1">
                        <p className="font-semibold text-slate-100">{question}</p>
                        <input
                          type="text"
                          value={quizResponses[idx] || ""}
                          onChange={(event) => handleQuizChange(idx, event.target.value)}
                          placeholder="Type your answer here..."
                          className="w-full rounded-xl border border-slate-700 bg-slate-900/80 px-3 py-2 text-sm text-slate-100 focus:border-amber-500 focus:outline-none"
                        />
                      </div>
                    ))}
                  </div>
                  <div className="mt-4 flex items-center gap-3">
                    <button type="button" className="btn" onClick={handleQuizSave}>
                      Save Quiz Answers
                    </button>
                    {quizSaved && <span className="text-sm text-emerald-300">Responses saved locally.</span>}
                  </div>
                </div>
              )}

              <div className="flex gap-3">
                <button className="btn" onClick={markLessonComplete}>
                  <Trophy size={18} />
                  Mark Complete & Next Lesson
                </button>
                {selectedLesson > 1 && (
                  <button className="btn-secondary" onClick={() => loadLesson(selectedLesson - 1)}>
                    Previous Lesson
                  </button>
                )}
                {selectedLesson < currentCourse.totalLessons && (
                  <button className="btn-secondary" onClick={() => loadLesson(selectedLesson + 1)}>
                    Next Lesson
                  </button>
                )}
              </div>
            </>
          )}
        </div>
      )}

      {/* Progress Summary */}
      <div className="rounded-2xl border border-amber-500/20 bg-slate-800/40 p-6">
        <h3 className="text-lg font-bold mb-3">Your Progress</h3>
        <div className="space-y-3">
          {Object.entries(courseData).map(([level, course]) => {
            const levelProgress = userData.hermeneuticsProgress?.[level] || { completedLessons: [] };
            const completed = levelProgress.completedLessons?.length || 0;
            const percent = Math.round((completed / course.totalLessons) * 100);

            return (
              <div key={level} className="flex items-center gap-3">
                <div className="w-32 font-semibold capitalize">{level}</div>
                <div className="flex-1 bg-slate-700 rounded-full h-3">
                  <div className="bg-amber-500 h-3 rounded-full transition-all" style={{ width: `${percent}%` }} />
                </div>
                <div className="w-20 text-right text-sm">
                  {completed}/{course.totalLessons}
                </div>
                {completed >= course.totalLessons && (
                  <Trophy className="text-amber-400" size={20} />
                )}
              </div>
            );
          })}
        </div>
      </div>
    </div>
  );
}

