// SwordDrillApp.jsx - Complete code with Help Section
import { signUp, signIn, signOut, onAuthChange } from './services/authService';
import { subscribeToUserProgress } from './services/dbService';
import { getUserData, addQuizResult } from './services/dbService';
import React, { useState, useEffect, useRef } from 'react';
import { Trophy, Book, Target, Award, Calendar, Menu, X, LogOut, User, Settings, Flame, BarChart, ChevronDown, ChevronRight, HelpCircle, Star, Zap, Heart, TrendingUp, Shield } from 'lucide-react';
import { APP_VERSION } from './version';
import { getRandomVerse, getRandomVerseByDifficulty, DIFFICULTY_CONFIG } from './services/bibleApiService';
import { APOCRYPHA_DIFFICULTY_CONFIG } from './services/bibleApiService';
import { formatVerseText } from './services/bibleApiService';
import { CANONICAL_BOOKS, APOCRYPHA_BOOKS } from './services/bibleApiService';
const BibleReaderView = React.lazy(() => import('./services/BibleReaderView'));
import './App.css';
import { getDailyVerse } from './dailyVerses';
import { db } from "./services/firebase";
import { doc, updateDoc } from "firebase/firestore";
import { getCurrentStreak } from "./services/StreakManager";
import SharpAssistant from './services/SharpAssistant';
import AnalyticsModal from './services/Analyticsmodal';

// ============================================
// ERROR BOUNDARY COMPONENT
// ============================================

class ErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false, error: null, errorInfo: null };
  }

  static getDerivedStateFromError(error) {
    return { hasError: true, error };
  }

  componentDidCatch(error, errorInfo) {
    console.error('‚ùå ErrorBoundary caught:', error);
    console.error('Error Info:', errorInfo);
    this.setState({ errorInfo });
  }

  render() {
    if (this.state.hasError) {
      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 flex items-center justify-center p-4">
          <div className="w-full max-w-md bg-red-900/30 border border-red-700 rounded-xl p-8">
            <h2 className="text-2xl font-bold text-red-300 mb-4">‚ö†Ô∏è Something went wrong</h2>
            <p className="text-red-200 mb-4 text-sm">{this.state.error?.message || 'An unexpected error occurred'}</p>
            <p className="text-red-100 text-xs mb-6 font-mono bg-red-950/50 p-3 rounded overflow-auto max-h-32">
              {this.state.error?.toString()}
            </p>
            <div className="flex gap-2">
              <button
                onClick={() => window.location.reload()}
                className="flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded font-semibold"
              >
                Reload Page
              </button>
              <button
                onClick={() => this.setState({ hasError: false })}
                className="flex-1 px-4 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded font-semibold"
              >
                Dismiss
              </button>
            </div>
          </div>
        </div>
      );
    }

    return this.props.children;
  }
}

// Sample verse database (In production, this would be 2000 verses from Firebase)
const VERSE_DATABASE = [
  { 
    id: 1, 
    reference: "John 3:16", 
    text: "For God so loved the world that He gave His only begotten Son, that whoever believes in Him should not perish but have everlasting life.", 
    translation: "NKJV", 
    category: "canonical", 
    topic: "salvation",
    difficulty: "Beginner"
  },
  { 
    id: 2, 
    reference: "Philippians 4:13", 
    text: "I can do all things through Christ who strengthens me.", 
    translation: "NKJV", 
    category: "canonical", 
    topic: "strength",
    difficulty: "Beginner"
  },
  { 
    id: 3, 
    reference: "Psalm 23:1", 
    text: "The Lord is my shepherd; I shall not want.", 
    translation: "NKJV", 
    category: "canonical", 
    topic: "comfort",
    difficulty: "Beginner"
  },
  { 
    id: 4, 
    reference: "Romans 8:28", 
    text: "And we know that all things work together for good to those who love God, to those who are the called according to His purpose.", 
    translation: "NKJV", 
    category: "canonical", 
    topic: "hope",
    difficulty: "Intermediate"
  },
  { 
    id: 5, 
    reference: "Proverbs 3:5-6", 
    text: "Trust in the Lord with all your heart, and lean not on your own understanding; in all your ways acknowledge Him, and He shall direct your paths.", 
    translation: "NKJV", 
    category: "canonical", 
    topic: "guidance",
    difficulty: "Intermediate"
  },
  { 
    id: 6, 
    reference: "Isaiah 40:31", 
    text: "But those who wait on the Lord shall renew their strength; they shall mount up with wings like eagles, they shall run and not be weary, they shall walk and not faint.", 
    translation: "NKJV", 
    category: "canonical", 
    topic: "strength",
    difficulty: "Intermediate"
  },
  { 
    id: 7, 
    reference: "Matthew 28:19-20", 
    text: "Go therefore and make disciples of all the nations, baptizing them in the name of the Father and of the Son and of the Holy Spirit, teaching them to observe all things that I have commanded you; and lo, I am with you always, even to the end of the age.", 
    translation: "NKJV", 
    category: "canonical", 
    topic: "faith",
    difficulty: "Advanced"
  },
  { 
    id: 8, 
    reference: "Jeremiah 29:11", 
    text: "For I know the thoughts that I think toward you, says the Lord, thoughts of peace and not of evil, to give you a future and a hope.", 
    translation: "NKJV", 
    category: "canonical", 
    topic: "hope",
    difficulty: "Beginner"
  },
  { 
    id: 9, 
    reference: "Psalm 119:105", 
    text: "Your word is a lamp to my feet and a light to my path.", 
    translation: "NKJV", 
    category: "canonical", 
    topic: "guidance",
    difficulty: "Beginner"
  },
  { 
    id: 10, 
    reference: "Romans 12:2", 
    text: "And do not be conformed to this world, but be transformed by the renewing of your mind, that you may prove what is that good and acceptable and perfect will of God.", 
    translation: "NKJV", 
    category: "canonical", 
    topic: "wisdom",
    difficulty: "Advanced"
  },
];

const ACHIEVEMENTS = {
  apprentice: [
    { id: 'a1', name: 'First Steps', desc: 'Complete your first quiz', icon: 'üéØ', req: 1 },
    { id: 'a2', name: 'Daily Devotion', desc: 'Check Verse of the Day', icon: 'üìñ', req: 1 },
    { id: 'a3', name: '10 Verses Strong', desc: 'Memorize 10 verses', icon: '‚öîÔ∏è', req: 10 },
    { id: 'a4', name: 'Week Warrior', desc: '7 day streak', icon: 'üî•', req: 7 },
  ],
  squire: [
    { id: 's1', name: 'Reference Master', desc: 'Complete 25 reference quizzes', icon: 'üìö', req: 25 },
    { id: 's2', name: '50 Verse Milestone', desc: 'Memorize 50 verses', icon: 'üèÜ', req: 50 },
    { id: 's3', name: 'Perfect Score', desc: 'Get 100% on any quiz', icon: '‚≠ê', req: 1 },
    { id: 's4', name: 'Month Faithful', desc: '30 day streak', icon: 'üî•', req: 30 },
  ],
  knight: [
    { id: 'k1', name: 'Century Club', desc: 'Memorize 100 verses', icon: 'üíØ', req: 100 },
    { id: 'k2', name: 'Quiz Champion', desc: 'Complete 100 quizzes', icon: 'üéì', req: 100 },
    { id: 'k3', name: 'Translation Scholar', desc: 'Practice with all 5 translations', icon: 'üìñ', req: 5 },
    { id: 'k4', name: 'Unwavering', desc: '60 day streak', icon: 'üî•', req: 60 },
  ],
  champion: [
    { id: 'c1', name: 'Half Millennium', desc: 'Memorize 500 verses', icon: 'üëë', req: 500 },
    { id: 'c2', name: 'Quiz Veteran', desc: 'Complete 500 quizzes', icon: 'üéñÔ∏è', req: 500 },
    { id: 'c3', name: 'Apocrypha Explorer', desc: 'Complete 25 Apocrypha verses', icon: 'üìú', req: 25 },
    { id: 'c4', name: 'Steadfast', desc: '100 day streak', icon: 'üî•', req: 100 },
  ],
  scholar: [
    { id: 'sc1', name: 'Millennium Mark', desc: 'Memorize 1000 verses', icon: 'üåü', req: 1000 },
    { id: 'sc2', name: 'Quiz Legend', desc: 'Complete 1000 quizzes', icon: 'üèÖ', req: 1000 },
    { id: 'sc3', name: 'Consistency King', desc: '365 day streak', icon: 'üî•', req: 365 },
    { id: 'sc4', name: 'Near Perfection', desc: 'Memorize 1900 verses', icon: 'üíé', req: 1900 },
  ],
};

const QUIZ_POINTS = {
  'fill-blank': 15,      // Hardest - most points
  'reference-recall': 10, // Medium difficulty
  'multiple-choice': 5    // Easiest - least points
};

// Category configuration
const CATEGORY_CONFIG = {
  difficulty: {
    name: 'By Difficulty',
    icon: '‚ö°',
    values: {
      'Beginner': { icon: 'üå±', color: 'from-green-500 to-green-600' },
      'Intermediate': { icon: 'üìò', color: 'from-blue-500 to-blue-600' },
      'Advanced': { icon: 'üî•', color: 'from-orange-500 to-orange-600' },
      'Expert': { icon: 'üëë', color: 'from-purple-500 to-purple-600' },
      'Eli Challenge': { icon: '‚öîÔ∏è', color: 'from-red-500 to-red-600' }
    }
  },
  topic: {
    name: 'By Topic',
    icon: 'üìö',
    values: {
      'salvation': { icon: '‚úùÔ∏è', color: 'from-amber-500 to-amber-600' },
      'strength': { icon: 'üí™', color: 'from-red-500 to-red-600' },
      'comfort': { icon: 'üïäÔ∏è', color: 'from-blue-400 to-blue-500' },
      'hope': { icon: 'üåü', color: 'from-yellow-500 to-yellow-600' },
      'guidance': { icon: 'üß≠', color: 'from-green-500 to-green-600' },
      'love': { icon: '‚ù§Ô∏è', color: 'from-pink-500 to-pink-600' },
      'faith': { icon: 'üôè', color: 'from-purple-500 to-purple-600' },
      'wisdom': { icon: 'ü¶â', color: 'from-indigo-500 to-indigo-600' },
      'courage': { icon: 'ü¶Å', color: 'from-orange-500 to-orange-600' },
      'peace': { icon: '‚òÆÔ∏è', color: 'from-teal-500 to-teal-600' }
    }
  },
  category: {
    name: 'By Category',
    icon: 'üìñ',
    values: {
      'canonical': { icon: 'üìú', color: 'from-amber-500 to-amber-600' },
      'apocrypha': { icon: 'üìö', color: 'from-purple-500 to-purple-600' }
    }
  }
};

// ‚úÖ Improved Helper Function to Calculate Streak (Duolingo-style logic)

const calculateStreak = (lastActivityDate, currentStreak) => {
  try {
    const today = new Date();
    // ‚úÖ Use ISO date format (YYYY-MM-DD) for consistency and timezone safety
    const todayISO = today.toISOString().split('T')[0];

    // ‚úÖ If no previous activity, this is first login
    if (!lastActivityDate) {
      console.log("üåü First login - starting streak at 1 day");
      return { streak: 1, lastActivity: todayISO };
    }

    // ‚úÖ Parse the last activity date
    let lastDate;
    if (typeof lastActivityDate === 'string') {
      // Handle ISO format (YYYY-MM-DD)
      lastDate = new Date(lastActivityDate + 'T00:00:00Z');
    } else if (typeof lastActivityDate === 'object' && 'seconds' in lastActivityDate) {
      // Handle Firebase Timestamp object
      lastDate = new Date(lastActivityDate.seconds * 1000 + Math.floor(lastActivityDate.nanoseconds / 1000000));
    } else {
      lastDate = new Date(lastActivityDate);
    }

    // ‚úÖ If parsing failed, treat as first login
    if (isNaN(lastDate.getTime())) {
      console.log("‚ö†Ô∏è Invalid date, treating as first login");
      return { streak: 1, lastActivity: todayISO };
    }

    const lastDateISO = lastDate.toISOString().split('T')[0];

    // üü¢ SAME DAY: No increment
    if (todayISO === lastDateISO) {
      console.log(`üòå Same day login - streak remains at ${currentStreak}`);
      return { streak: currentStreak, lastActivity: lastDateISO };
    }

    // üü° YESTERDAY: Increment streak
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    const yesterdayISO = yesterday.toISOString().split('T')[0];

    if (lastDateISO === yesterdayISO) {
      const newStreak = currentStreak + 1;
      console.log(`üî• Consecutive day! Streak: ${currentStreak} ‚Üí ${newStreak}`);
      return { streak: newStreak, lastActivity: todayISO };
    }

    // üî¥ MISSED DAYS: Reset to 1
    const daysMissed = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));
    console.log(`üíÄ Missed ${daysMissed} days. Streak reset to 1.`);
    return { streak: 1, lastActivity: todayISO };

  } catch (error) {
    console.error("‚ùå Error in calculateStreak:", error);
    // Fallback: maintain current streak on error
    return { streak: currentStreak || 1, lastActivity: new Date().toISOString().split('T')[0] };
  }
};

// Robust API call with retry logic and fallback
const fetchVerseWithRetry = async (translation, difficulty, includeApocrypha, maxRetries = 3) => {
  let lastError = null;

  for (let attempt = 0; attempt < maxRetries; attempt++) {
    try {
      // Local-first: if we have predefined verse lists for this difficulty, try resolving from local per-book JSON.
      const cfg = DIFFICULTY_CONFIG[difficulty] || APOCRYPHA_DIFFICULTY_CONFIG[difficulty];
      if (cfg && Array.isArray(cfg.verses) && cfg.verses.length > 0) {
        const randomRef = cfg.verses[Math.floor(Math.random() * cfg.verses.length)];
        try {
          const local = await getLocalVerseByReference(translation, randomRef);
          if (local && local.text) {
            return { verse: { reference: local.reference, text: local.text, translation }, source: 'local' };
          }
        } catch (_) {
          // ignore local failure and continue with API path
        }
      }
      const timeoutPromise = new Promise((_, reject) => 
        setTimeout(() => reject(new Error('API timeout')), 10000)
      );
      
      const apiPromise = getRandomVerseByDifficulty(translation, difficulty, includeApocrypha);
      const verse = await Promise.race([apiPromise, timeoutPromise]);
      
      if (verse && verse.text && verse.reference) {
        return { verse, source: 'api' };
      } else {
        throw new Error('Invalid verse data from API');
      }
      
    } catch (error) {
      lastError = error;
      if (attempt < maxRetries - 1) {
        await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
      }
    }
  }
  
  return { verse: null, source: 'fallback', error: lastError };
};

// Get fallback verse from local database
const getFallbackVerse = (difficulty, verseProgress) => {
  let filteredVerses = VERSE_DATABASE.filter(v => v.difficulty === difficulty);
  
  if (filteredVerses.length === 0) {
    filteredVerses = VERSE_DATABASE;
  }
  
  const versesNeedingReview = filteredVerses.filter(v => {
    const progress = verseProgress[v.reference];
    if (!progress) return true;
    
    const now = Date.now();
    if (progress.nextReview && now >= progress.nextReview) return true;
    
    return false;
  });

  const versePool = versesNeedingReview.length > 0 ? versesNeedingReview : filteredVerses;
  const randomIndex = Math.floor(Math.random() * versePool.length);
  return { ...versePool[randomIndex] };
};
const calculateSimilarity = (str1, str2) => {
  const s1 = str1.toLowerCase().trim();
  const s2 = str2.toLowerCase().trim();
  
  if (s1 === s2) return 1;
  if (s1.length === 0 || s2.length === 0) return 0;
  
  const matrix = [];
  
  for (let i = 0; i <= s2.length; i++) {
    matrix[i] = [i];
  }
  
  for (let j = 0; j <= s1.length; j++) {
    matrix[0][j] = j;
  }
  
  for (let i = 1; i <= s2.length; i++) {
    for (let j = 1; j <= s1.length; j++) {
      if (s2.charAt(i - 1) === s1.charAt(j - 1)) {
        matrix[i][j] = matrix[i - 1][j - 1];
      } else {
        matrix[i][j] = Math.min(
          matrix[i - 1][j - 1] + 1,
          matrix[i][j - 1] + 1,
          matrix[i - 1][j] + 1
        );
      }
    }
  }
  
  const maxLength = Math.max(s1.length, s2.length);
  const distance = matrix[s2.length][s1.length];
  return 1 - (distance / maxLength);
};

/**
 * Check if user answer matches correct answer (with fuzzy matching)
 */
const checkAnswerMatch = (userAnswer, correctAnswer) => {
  const cleanUser = (userAnswer || '')
    .toLowerCase()
    .trim()
    .replace(/[.,;:!?'"]/g, '');
  
  const cleanCorrect = correctAnswer
    .toLowerCase()
    .trim()
    .replace(/[.,;:!?'"]/g, '');
  
  if (cleanUser === cleanCorrect) {
    return { isCorrect: true, similarity: 1.0 };
  }
  
  const variations = {
    'strengtheneth': ['strengthens', 'strengthen'],
    'loveth': ['loves', 'love'],
    'believeth': ['believes', 'believe'],
    'knoweth': ['knows', 'know'],
    'doeth': ['does', 'do'],
    'cometh': ['comes', 'come'],
    'goeth': ['goes', 'go'],
    'giveth': ['gives', 'give'],
    'maketh': ['makes', 'make'],
    'speaketh': ['speaks', 'speak'],
    'walketh': ['walks', 'walk'],
    'worketh': ['works', 'work'],
  };
  
  for (const [kjvForm, modernForms] of Object.entries(variations)) {
    if (cleanCorrect.includes(kjvForm)) {
      for (const modernForm of modernForms) {
        const modernVersion = cleanCorrect.replace(kjvForm, modernForm);
        if (cleanUser === modernVersion) {
          return { isCorrect: true, similarity: 0.95 };
        }
      }
    }
  }
  
  const similarity = calculateSimilarity(cleanUser, cleanCorrect);
  const threshold = cleanCorrect.length >= 5 ? 0.85 : 
                   cleanCorrect.length >= 4 ? 0.80 : 
                   0.75;
  
  return { 
    isCorrect: similarity >= threshold, 
    similarity 
  };
};

// Add this ancient texts data structure before the SwordDrillApp component
const ANCIENT_TEXTS = {
  lxx: {
    name: "Septuagint (LXX)",
    description: "Greek Old Testament (3rd-1st century BCE)",
    books: {
      genesis: {
        name: "Genesis",
        greekName: "ŒìŒ≠ŒΩŒµœÉŒπœÇ",
        translitName: "Genesis",
        chapters: {
          1: {
            verses: {
              1: {
                greek: "·ºòŒΩ ·ºÄœÅœá·øá ·ºêœÄŒøŒØŒ∑œÉŒµŒΩ ·ΩÅ Œ∏Œµ·Ω∏œÇ œÑ·Ω∏ŒΩ Œø·ΩêœÅŒ±ŒΩ·Ω∏ŒΩ Œ∫Œ±·Ω∂ œÑ·Ω¥ŒΩ Œ≥·øÜŒΩ",
                transliterated: "En archƒì epoiƒìsen ho theos ton ouranon kai tƒìn gƒìn",
                english: "In the beginning God made the heaven and the earth",
                reference: "Genesis 1:1"
              },
              2: {
                greek: "·º° Œ¥·Ω≤ Œ≥·øÜ ·º¶ŒΩ ·ºÄœåœÅŒ±œÑŒøœÇ Œ∫Œ±·Ω∂ ·ºÄŒ∫Œ±œÑŒ±œÉŒ∫ŒµœçŒ±œÉœÑŒøœÇ Œ∫Œ±·Ω∂ œÉŒ∫œåœÑŒøœÇ ·ºêœÄŒ¨ŒΩœâ œÑ·øÜœÇ ·ºÄŒ≤œçœÉœÉŒøœÖ",
                transliterated: "hƒì de gƒì ƒìn aoratos kai akataskeuastos kai skotos epan≈ç tƒìs abyssou",
                english: "And the earth was invisible and unformed, and darkness was over the abyss",
                reference: "Genesis 1:2"
              },
              3: {
                greek: "Œ∫Œ±·Ω∂ Œµ·º∂œÄŒµŒΩ ·ΩÅ Œ∏ŒµœåœÇ ŒìŒµŒΩŒ∑Œ∏ŒÆœÑœâ œÜ·ø∂œÇ Œ∫Œ±·Ω∂ ·ºêŒ≥Œ≠ŒΩŒµœÑŒø œÜ·ø∂œÇ",
                transliterated: "kai eipen ho theos Genƒìthƒìt≈ç ph≈çs kai egeneto ph≈çs",
                english: "And God said, Let there be light, and there was light",
                reference: "Genesis 1:3"
              }
            }
          },
          2: {
            verses: {
              1: {
                greek: "ŒöŒ±·Ω∂ œÉœÖŒΩŒµœÑŒµŒªŒ≠œÉŒ∏Œ∑œÉŒ±ŒΩ ·ΩÅ Œø·ΩêœÅŒ±ŒΩ·Ω∏œÇ Œ∫Œ±·Ω∂ ·º° Œ≥·øÜ Œ∫Œ±·Ω∂ œÄ·æ∂œÇ ·ΩÅ Œ∫œåœÉŒºŒøœÇ Œ±·ΩêœÑ·ø∂ŒΩ",
                transliterated: "Kai synetelesthƒìsan ho ouranos kai hƒì gƒì kai pas ho kosmos aut≈çn",
                english: "And the heaven and earth were finished, and all their world",
                reference: "Genesis 2:1"
              }
            }
          }
        }
      },
      exodus: {
        name: "Exodus",
        greekName: "·ºúŒæŒøŒ¥ŒøœÇ",
        translitName: "Exodos",
        chapters: {
          1: {
            verses: {
              1: {
                greek: "Œ§Œ±·ø¶œÑŒ± œÑ·Ω∞ ·ΩÄŒΩœåŒºŒ±œÑŒ± œÑ·ø∂ŒΩ œÖ·º±·ø∂ŒΩ ŒôœÉœÅŒ±Œ∑Œª œÑ·ø∂ŒΩ Œµ·º∞œÉœÄŒµœÄŒøœÅŒµœÖŒºŒ≠ŒΩœâŒΩ Œµ·º∞œÇ Œë·º¥Œ≥œÖœÄœÑŒøŒΩ",
                transliterated: "Tauta ta onomata t≈çn hui≈çn Israƒìl t≈çn eispeporeuomen≈çn eis Aigypton",
                english: "These are the names of the sons of Israel who came into Egypt",
                reference: "Exodus 1:1"
              }
            }
          }
        }
      },
      psalms: {
        name: "Psalms",
        greekName: "Œ®Œ±ŒªŒºŒøŒØ",
        translitName: "Psalmoi",
        chapters: {
          1: {
            verses: {
              1: {
                greek: "ŒúŒ±Œ∫Œ¨œÅŒπŒøœÇ ·ºÄŒΩŒÆœÅ ·ΩÉœÇ Œø·ΩêŒ∫ ·ºêœÄŒøœÅŒµœçŒ∏Œ∑ ·ºêŒΩ Œ≤ŒøœÖŒª·øá ·ºÄœÉŒµŒ≤·ø∂ŒΩ",
                transliterated: "Makarios anƒìr hos ouk eporeuthƒì en boulƒì aseb≈çn",
                english: "Blessed is the man who has not walked in the counsel of the ungodly",
                reference: "Psalm 1:1"
              }
            }
          }
        }
      }
    }
  },
  sinaiticus: {
    name: "Codex Sinaiticus",
    description: "4th Century Complete Bible",
    books: {
      matthew: {
        name: "Matthew",
        greekName: "ŒöŒ±œÑ·Ω∞ ŒúŒ±œÑŒ∏Œ±·øñŒøŒΩ",
        translitName: "Kata Matthaion",
        chapters: {
          1: {
            verses: {
              1: {
                greek: "ŒíŒØŒ≤ŒªŒøœÇ Œ≥ŒµŒΩŒ≠œÉŒµœâœÇ ·º∏Œ∑œÉŒø·ø¶ ŒßœÅŒπœÉœÑŒø·ø¶ œÖ·º±Œø·ø¶ ŒîŒ±œÖ·Ω∂Œ¥ œÖ·º±Œø·ø¶ ·ºàŒ≤œÅŒ±Œ¨Œº",
                transliterated: "Biblos genese≈çs Iƒìsou Christou huiou Dauid huiou Abraam",
                english: "The book of the genealogy of Jesus Christ, son of David, son of Abraham",
                reference: "Matthew 1:1"
              },
              18: {
                greek: "Œ§Œø·ø¶ Œ¥·Ω≤ ·º∏Œ∑œÉŒø·ø¶ ŒßœÅŒπœÉœÑŒø·ø¶ ·º° Œ≥Œ≠ŒΩŒµœÉŒπœÇ Œø·ΩïœÑœâœÇ ·º¶ŒΩ",
                transliterated: "Tou de Iƒìsou Christou hƒì genesis hout≈çs ƒìn",
                english: "Now the birth of Jesus Christ was as follows",
                reference: "Matthew 1:18"
              }
            }
          }
        }
      },
      john: {
        name: "John",
        greekName: "ŒöŒ±œÑ·Ω∞ ·º∏œâŒ¨ŒΩŒΩŒ∑ŒΩ",
        translitName: "Kata I≈çannƒìn",
        chapters: {
          1: {
            verses: {
              1: {
                greek: "·ºòŒΩ ·ºÄœÅœá·øá ·º¶ŒΩ ·ΩÅ ŒªœåŒ≥ŒøœÇ Œ∫Œ±·Ω∂ ·ΩÅ ŒªœåŒ≥ŒøœÇ ·º¶ŒΩ œÄœÅ·Ω∏œÇ œÑ·Ω∏ŒΩ Œ∏ŒµœåŒΩ Œ∫Œ±·Ω∂ Œ∏Œµ·Ω∏œÇ ·º¶ŒΩ ·ΩÅ ŒªœåŒ≥ŒøœÇ",
                transliterated: "En archƒì ƒìn ho logos kai ho logos ƒìn pros ton theon kai theos ƒìn ho logos",
                english: "In the beginning was the Word, and the Word was with God, and the Word was God",
                reference: "John 1:1"
              },
              14: {
                greek: "ŒöŒ±·Ω∂ ·ΩÅ ŒªœåŒ≥ŒøœÇ œÉ·Ω∞œÅŒæ ·ºêŒ≥Œ≠ŒΩŒµœÑŒø Œ∫Œ±·Ω∂ ·ºêœÉŒ∫ŒÆŒΩœâœÉŒµŒΩ ·ºêŒΩ ·º°Œº·øñŒΩ",
                transliterated: "Kai ho logos sarx egeneto kai eskƒìn≈çsen en hƒìmin",
                english: "And the Word became flesh and dwelt among us",
                reference: "John 1:14"
              }
            }
          },
          3: {
            verses: {
              16: {
                greek: "Œü·ΩïœÑœâœÇ Œ≥·Ω∞œÅ ·º†Œ≥Œ¨œÄŒ∑œÉŒµŒΩ ·ΩÅ Œ∏Œµ·Ω∏œÇ œÑ·Ω∏ŒΩ Œ∫œåœÉŒºŒøŒΩ ·Ω•œÉœÑŒµ œÑ·Ω∏ŒΩ œÖ·º±·Ω∏ŒΩ œÑ·Ω∏ŒΩ ŒºŒøŒΩŒøŒ≥ŒµŒΩ·øÜ ·ºîŒ¥œâŒ∫ŒµŒΩ",
                transliterated: "Hout≈çs gar ƒìgapƒìsen ho theos ton kosmon h≈çste ton huion ton monogenƒì ed≈çken",
                english: "For God so loved the world that He gave His only begotten Son",
                reference: "John 3:16"
              }
            }
          }
        }
      },
      romans: {
        name: "Romans",
        greekName: "Œ†œÅ·Ω∏œÇ ·ø¨œâŒºŒ±ŒØŒøœÖœÇ",
        translitName: "Pros Rh≈çmaious",
        chapters: {
          1: {
            verses: {
              1: {
                greek: "Œ†Œ±·ø¶ŒªŒøœÇ Œ¥Œø·ø¶ŒªŒøœÇ ŒßœÅŒπœÉœÑŒø·ø¶ ·º∏Œ∑œÉŒø·ø¶ Œ∫ŒªŒ∑œÑ·Ω∏œÇ ·ºÄœÄœåœÉœÑŒøŒªŒøœÇ",
                transliterated: "Paulos doulos Christou Iƒìsou klƒìtos apostolos",
                english: "Paul, a servant of Christ Jesus, called to be an apostle",
                reference: "Romans 1:1"
              }
            }
          }
        }
      }
    }
  }
};

// Replace the existing AncientStudyView with this enhanced version:
const AncientStudyView = ({ userData }) => {
  const [selectedText, setSelectedText] = useState('lxx');
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedBook, setSelectedBook] = useState(null);
  const [selectedChapter, setSelectedChapter] = useState(null);
  const [viewMode, setViewMode] = useState('browse'); // 'browse', 'search', 'compare'
  const [compareVerse, setCompareVerse] = useState(null);
  const [showGreek, setShowGreek] = useState(true);
  const [showTranslit, setShowTranslit] = useState(true);
  const [showEnglish, setShowEnglish] = useState(true);
  const [bookmarks, setBookmarks] = useState([]);
  const currentTextData = ANCIENT_TEXTS[selectedText];
  const [hasUnseenAchievements, setHasUnseenAchievements] = useState(false);
const [lastSeenAchievementsCount, setLastSeenAchievementsCount] = useState(() => {
  const saved = localStorage.getItem('lastSeenAchievementsCount');
  return saved ? parseInt(saved) : 0;
});

  // Search functionality
  const searchResults = () => {
    if (!searchTerm) return [];
    
    const results = [];
    const searchLower = searchTerm.toLowerCase();
    
    Object.entries(currentTextData.books).forEach(([bookKey, bookData]) => {
      Object.entries(bookData.chapters).forEach(([chapterNum, chapterData]) => {
        Object.entries(chapterData.verses).forEach(([verseNum, verseData]) => {
          if (
            verseData.english.toLowerCase().includes(searchLower) ||
            verseData.transliterated.toLowerCase().includes(searchLower) ||
            verseData.reference.toLowerCase().includes(searchLower)
          ) {
            results.push({
              bookKey,
              bookName: bookData.name,
              chapterNum,
              verseNum,
              ...verseData
            });
          }
        });
      });
    });
    
    return results;
  };

  const handleVerseClick = (verse) => {
    if (viewMode === 'compare') {
      setCompareVerse(verse);
    }
  };

  const toggleBookmark = (verse) => {
    const bookmarkId = `${selectedText}-${verse.reference}`;
    if (bookmarks.includes(bookmarkId)) {
      setBookmarks(bookmarks.filter(b => b !== bookmarkId));
    } else {
      setBookmarks([...bookmarks, bookmarkId]);
    }
  };

  const VerseDisplay = ({ verse, showBookmark = true }) => (
    <div className="bg-slate-800/50 rounded-lg p-4 space-y-3 hover:bg-slate-800/70 transition-all">
      <div className="flex items-start justify-between">
        <div className="font-bold text-amber-400">{verse.reference}</div>
        {showBookmark && (
          <button
            onClick={() => toggleBookmark(verse)}
            className="text-amber-400 hover:text-amber-300"
          >
            {bookmarks.includes(`${selectedText}-${verse.reference}`) ? '‚òÖ' : '‚òÜ'}
          </button>
        )}
      </div>
      
      {showGreek && verse.greek && (
        <div className="text-lg text-blue-300 font-serif">
          {verse.greek}
        </div>
      )}
      
      {showTranslit && (
        <div className="text-sm text-green-400 italic">
          {verse.transliterated}
        </div>
      )}
      
      {showEnglish && (
        <div className="text-white">
          {verse.english}
        </div>
      )}
    </div>
  );

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="text-center">
        <Book className="mx-auto text-amber-400 mb-2" size={48} />
        <h2 className="text-2xl font-bold text-amber-400">Ancient Study</h2>
        <p className="text-slate-300">Explore ancient Biblical manuscripts</p>
      </div>

      {/* Introduction Card */}
      <div className="bg-gradient-to-br from-amber-500/10 to-amber-600/10 border-2 border-amber-500/30 rounded-2xl p-6">
        <div className="text-center">
          <div className="text-4xl mb-3">üìú</div>
          <h3 className="text-xl font-bold text-amber-400 mb-2">
            {currentTextData.name}
          </h3>
          <p className="text-slate-300 text-sm leading-relaxed">
            {currentTextData.description}
          </p>
        </div>
      </div>

      {/* Text Selection Tabs */}
      <div className="bg-slate-700/50 rounded-xl p-2 border border-slate-600">
        <div className="grid grid-cols-2 gap-2">
          <button
            onClick={() => {
              setSelectedText('lxx');
              setSelectedBook(null);
              setSelectedChapter(null);
            }}
            className={`flex items-center justify-center gap-2 p-3 rounded-lg transition-all ${
              selectedText === 'lxx'
                ? 'bg-amber-500 text-slate-900 font-bold'
                : 'bg-slate-600 text-white hover:bg-slate-500'
            }`}
          >
            <span>üèõÔ∏è</span>
            <span className="text-sm">Septuagint (LXX)</span>
          </button>
          <button
            onClick={() => {
              setSelectedText('sinaiticus');
              setSelectedBook(null);
              setSelectedChapter(null);
            }}
            className={`flex items-center justify-center gap-2 p-3 rounded-lg transition-all ${
              selectedText === 'sinaiticus'
                ? 'bg-amber-500 text-slate-900 font-bold'
                : 'bg-slate-600 text-white hover:bg-slate-500'
            }`}
          >
            <span>‚úùÔ∏è</span>
            <span className="text-sm">Codex Sinaiticus</span>
          </button>
        </div>
      </div>

      {/* View Mode Tabs */}
      <div className="bg-slate-700/50 rounded-xl p-2 border border-slate-600">
        <div className="grid grid-cols-3 gap-2">
          <button
            onClick={() => setViewMode('browse')}
            className={`p-2 rounded-lg transition-all text-sm ${
              viewMode === 'browse'
                ? 'bg-blue-500 text-white font-bold'
                : 'bg-slate-600 text-white hover:bg-slate-500'
            }`}
          >
            Browse
          </button>
          <button
            onClick={() => setViewMode('search')}
            className={`p-2 rounded-lg transition-all text-sm ${
              viewMode === 'search'
                ? 'bg-blue-500 text-white font-bold'
                : 'bg-slate-600 text-white hover:bg-slate-500'
            }`}
          >
            Search
          </button>
          <button
            onClick={() => setViewMode('compare')}
            className={`p-2 rounded-lg transition-all text-sm ${
              viewMode === 'compare'
                ? 'bg-blue-500 text-white font-bold'
                : 'bg-slate-600 text-white hover:bg-slate-500'
            }`}
          >
            Compare
          </button>
        </div>
      </div>

      {/* Display Options */}
      <div className="bg-slate-700/50 rounded-xl p-4 border border-slate-600">
        <div className="flex items-center justify-between mb-2">
          <span className="text-white font-bold text-sm">Display Options</span>
        </div>
        <div className="flex gap-4">
          <label className="flex items-center gap-2 text-sm">
            <input
              type="checkbox"
              checked={showGreek}
              onChange={(e) => setShowGreek(e.target.checked)}
              className="rounded"
            />
            <span className="text-slate-300">Greek</span>
          </label>
          <label className="flex items-center gap-2 text-sm">
            <input
              type="checkbox"
              checked={showTranslit}
              onChange={(e) => setShowTranslit(e.target.checked)}
              className="rounded"
            />
            <span className="text-slate-300">Transliterated</span>
          </label>
          <label className="flex items-center gap-2 text-sm">
            <input
              type="checkbox"
              checked={showEnglish}
              onChange={(e) => setShowEnglish(e.target.checked)}
              className="rounded"
            />
            <span className="text-slate-300">English</span>
          </label>
        </div>
      </div>

      {/* Search Mode */}
      {viewMode === 'search' && (
        <div className="space-y-4">
          <div className="bg-slate-700/50 rounded-xl p-4 border border-slate-600">
            <input
              type="text"
              placeholder="Search for words or references..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="w-full px-4 py-3 rounded-lg bg-slate-800 text-white border border-slate-600 focus:border-amber-500 focus:outline-none"
              autoFocus
            />
          </div>

          {searchTerm && (
            <div className="space-y-3">
              <div className="text-sm text-slate-400">
                Found {searchResults().length} results
              </div>
              {searchResults().slice(0, 10).map((verse, idx) => (
                <div key={idx} onClick={() => handleVerseClick(verse)}>
                  <VerseDisplay verse={verse} />
                </div>
              ))}
            </div>
          )}
        </div>
      )}

      {/* Browse Mode */}
      {viewMode === 'browse' && (
        <div className="space-y-4">
          {!selectedBook && (
            <div className="grid grid-cols-2 gap-3">
              {Object.entries(currentTextData.books).map(([bookKey, bookData]) => (
                <button
                  key={bookKey}
                  onClick={() => {
                    setSelectedBook(bookKey);
                    setSelectedChapter(null);
                  }}
                  className="bg-slate-700/50 hover:bg-slate-600 text-white p-4 rounded-xl border border-slate-600 hover:border-amber-500 transition-all"
                >
                  <div className="font-bold">{bookData.name}</div>
                  <div className="text-sm text-slate-400">{bookData.greekName}</div>
                  <div className="text-xs text-amber-400 italic">{bookData.translitName}</div>
                </button>
              ))}
            </div>
          )}

          {selectedBook && !selectedChapter && (
            <div>
              <button
                onClick={() => setSelectedBook(null)}
                className="mb-4 text-amber-400 hover:text-amber-300"
              >
                ‚Üê Back to Books
              </button>
              <h3 className="text-xl font-bold text-amber-400 mb-4">
                {currentTextData.books[selectedBook].name} - Select Chapter
              </h3>
              <div className="grid grid-cols-4 gap-3">
                {Object.keys(currentTextData.books[selectedBook].chapters).map(chapterNum => (
                  <button
                    key={chapterNum}
                    onClick={() => setSelectedChapter(chapterNum)}
                    className="bg-slate-700/50 hover:bg-slate-600 text-white p-4 rounded-xl border border-slate-600 hover:border-amber-500 transition-all font-bold"
                  >
                    Chapter {chapterNum}
                  </button>
                ))}
              </div>
            </div>
          )}

          {selectedBook && selectedChapter && (
            <div>
              <button
                onClick={() => setSelectedChapter(null)}
                className="mb-4 text-amber-400 hover:text-amber-300"
              >
                ‚Üê Back to Chapters
              </button>
              <h3 className="text-xl font-bold text-amber-400 mb-4">
                {currentTextData.books[selectedBook].name} Chapter {selectedChapter}
              </h3>
              <div className="space-y-3">
                {Object.entries(currentTextData.books[selectedBook].chapters[selectedChapter].verses).map(([verseNum, verseData]) => (
                  <div key={verseNum} onClick={() => handleVerseClick(verseData)}>
                    <VerseDisplay verse={verseData} />
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      )}

      {/* Compare Mode */}
      {viewMode === 'compare' && (
        <div className="space-y-4">
          <div className="bg-amber-500/10 border border-amber-500/30 rounded-lg p-4">
            <p className="text-amber-400 text-sm">
              üí° Browse or search for verses, then click on them to compare with modern translations
            </p>
          </div>

          {compareVerse && (
            <div className="space-y-4">
              <h3 className="text-xl font-bold text-amber-400">Comparing: {compareVerse.reference}</h3>
              
              <div className="grid gap-4">
                <div>
                  <h4 className="text-sm font-bold text-slate-400 mb-2">{currentTextData.name}</h4>
                  <VerseDisplay verse={compareVerse} showBookmark={false} />
                </div>
                
                <div>
                  <h4 className="text-sm font-bold text-slate-400 mb-2">Modern Translation (NKJV)</h4>
                  <div className="bg-slate-800/50 rounded-lg p-4">
                    <div className="text-white">
                      {/* This would pull from your main verse database */}
                      {VERSE_DATABASE.find(v => v.reference === compareVerse.reference)?.text || 
                       "Modern translation not available for comparison"}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      )}

      {/* Bookmarks */}
      {bookmarks.length > 0 && (
        <div className="bg-slate-700/50 rounded-xl p-4 border border-slate-600">
          <h3 className="text-white font-bold mb-3">‚òÖ Bookmarked Verses ({bookmarks.length})</h3>
          <div className="text-sm text-amber-400">
            {bookmarks.join(', ')}
          </div>
        </div>
      )}

      {/* Study Tips */}
      <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
        <h4 className="text-blue-400 font-bold mb-2">üìñ Study Tips</h4>
        <ul className="text-slate-300 text-sm space-y-1">
          <li>‚Ä¢ Compare ancient texts with modern translations to see how Scripture has been preserved</li>
          <li>‚Ä¢ The transliterated text helps you pronounce the original Greek</li>
          <li>‚Ä¢ Notice textual variants between Septuagint (OT) and Codex Sinaiticus (NT)</li>
          <li>‚Ä¢ Bookmark important verses for quick reference</li>
        </ul>
      </div>
    </div>
  );
};
// ‚úÖ Animated Streak Display Component (with flame glow)
// ‚úÖ Sword Drill StreakDisplay (upgraded with tier-based flame colors)

const StreakDisplay = ({ streak }) => {
  const [animate, setAnimate] = useState(false);

  // üî• Determine flame tier based on streak length
  const getFlameClass = () => {
    if (streak >= 100) return "flame-legendary";
    if (streak >= 30) return "flame-red";
    if (streak >= 7) return "flame-orange";
    return "flame-gold";
  };

  // üü° Animate glow when streak changes (like your old version)
  useEffect(() => {
    if (streak > 0) {
      setAnimate(true);
      const timer = setTimeout(() => setAnimate(false), 800);
      return () => clearTimeout(timer);
    }
  }, [streak]);

  // üé® Render streak (preserves your old layout & classes)
  
  return (
    <div className={`streak-container ${animate ? "streak-animate" : ""}`}>
      <span className={`streak-flame ${getFlameClass()}`}>
        <span className="flame-outer"></span>
        <span className="flame-inner"></span>
        <span className="flame-core"></span>
    </span>
    <span className={`streak-count ${getFlameClass()} glow`}>
      {streak} day{streak !== 1 ? "s" : ""}
    </span>
  </div>
);
};

// ============================================
// VIEW COMPONENTS (Extracted from SwordDrillApp)
// ============================================

const HelpView = () => {
  const [expandedSection, setExpandedSection] = useState('getting-started');

  const toggleSection = (section) => {
    setExpandedSection(expandedSection === section ? null : section);
  };

  return (
    <div className="space-y-6">
      <div className="text-center">
        <HelpCircle className="mx-auto text-amber-400 mb-2" size={48} />
        <h2 className="text-2xl font-bold text-amber-400">Help & Guide</h2>
        <p className="text-slate-300">Everything you need to know about Sword Drill</p>
      </div>

      {/* Welcome */}
      <div className="bg-gradient-to-br from-amber-500/10 to-amber-600/10 border-2 border-amber-500/30 rounded-2xl p-6">
        <div className="text-center">
          <div className="text-4xl mb-3">‚öîÔ∏è</div>
          <h3 className="text-xl font-bold text-amber-400 mb-2">Welcome to Sword Drill!</h3>
          <p className="text-slate-300 text-sm leading-relaxed">
            Your gamified Bible memorization companion. Master Scripture through engaging quizzes,
            track your progress, and unlock achievements as you grow in God's Word.
          </p>
        </div>
      </div>

      {/* Getting Started */}
      <div className="bg-slate-700/50 rounded-xl border border-slate-600 overflow-hidden">
        <button
          onClick={() => toggleSection('getting-started')}
          className="w-full p-4 flex items-center justify-between hover:bg-slate-700/70 transition-all"
        >
          <div className="flex items-center gap-3">
            <Star className="text-amber-400" size={24} />
            <span className="font-bold text-white text-lg">Getting Started</span>
          </div>
          {expandedSection === 'getting-started' ? (
            <ChevronDown className="text-amber-400" size={24} />
          ) : (
            <ChevronRight className="text-amber-400" size={24} />
          )}
        </button>

        {expandedSection === 'getting-started' && (
          <div className="border-t border-slate-600 bg-slate-800/30 p-6 space-y-4">
            <div>
              <h4 className="text-amber-400 font-bold mb-2">üè† Home Dashboard</h4>
              <p className="text-slate-300 text-sm leading-relaxed">
                Your home screen shows your current difficulty level, verse of the day, and key stats.
                Start training by selecting one of three quiz types.
              </p>
            </div>

            <div>
              <h4 className="text-amber-400 font-bold mb-2">üìä Track Your Progress</h4>
              <p className="text-slate-300 text-sm leading-relaxed">
                Monitor your verses memorized, current streak, quizzes completed, and total points.
                Each stat reflects your dedication to Scripture.
              </p>
            </div>

            <div>
              <h4 className="text-amber-400 font-bold mb-2">üî• Daily Streaks</h4>
              <p className="text-slate-300 text-sm leading-relaxed">
                Log in daily to maintain your streak! Complete at least one quiz per day to keep the flame burning.
              </p>
            </div>
          </div>
        )}
      </div>

      {/* Quiz Types */}
      <div className="bg-slate-700/50 rounded-xl border border-slate-600 overflow-hidden">
        <button
          onClick={() => toggleSection('quiz-types')}
          className="w-full p-4 flex items-center justify-between hover:bg-slate-700/70 transition-all"
        >
          <div className="flex items-center gap-3">
            <Target className="text-amber-400" size={24} />
            <span className="font-bold text-white text-lg">Quiz Types</span>
          </div>
          {expandedSection === 'quiz-types' ? (
            <ChevronDown className="text-amber-400" size={24} />
          ) : (
            <ChevronRight className="text-amber-400" size={24} />
          )}
        </button>

        {expandedSection === 'quiz-types' && (
          <div className="border-t border-slate-600 bg-slate-800/30 p-6 space-y-4">
            <div className="bg-amber-500/10 border border-amber-500/30 rounded-lg p-4">
              <div className="flex items-center justify-between mb-2">
                <h4 className="text-amber-400 font-bold">‚úèÔ∏è Fill in the Blanks</h4>
                <span className="bg-amber-500 text-slate-900 px-2 py-1 rounded text-xs font-bold">+15 pts</span>
              </div>
              <p className="text-slate-300 text-sm leading-relaxed mb-2">
                Complete verses with 3-5 missing words. The hardest quiz type with the most points!
              </p>
              <p className="text-amber-400 text-xs">
                üí° Tip: You need 80% correct to pass. Focus on context clues!
              </p>
            </div>

            <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
              <div className="flex items-center justify-between mb-2">
                <h4 className="text-blue-400 font-bold">üîç Reference Recall</h4>
                <span className="bg-blue-500 text-white px-2 py-1 rounded text-xs font-bold">+10 pts</span>
              </div>
              <p className="text-slate-300 text-sm leading-relaxed mb-2">
                Type the Bible reference for the displayed verse. Medium difficulty.
              </p>
              <p className="text-blue-400 text-xs">
                üí° Tip: Format matters! Use proper format like "John 3:16"
              </p>
            </div>

            <div className="bg-green-500/10 border border-green-500/30 rounded-lg p-4">
              <div className="flex items-center justify-between mb-2">
                <h4 className="text-green-400 font-bold">üìù Multiple Choice</h4>
                <span className="bg-green-500 text-white px-2 py-1 rounded text-xs font-bold">+5 pts</span>
              </div>
              <p className="text-slate-300 text-sm leading-relaxed mb-2">
                Choose the correct reference from 4 options. Great for beginners!
              </p>
              <p className="text-green-400 text-xs">
                üí° Tip: Perfect for learning new verses and building confidence.
              </p>
            </div>
          </div>
        )}
      </div>

      {/* Difficulty Levels */}
      <div className="bg-slate-700/50 rounded-xl border border-slate-600 overflow-hidden">
        <button
          onClick={() => toggleSection('difficulty')}
          className="w-full p-4 flex items-center justify-between hover:bg-slate-700/70 transition-all"
        >
          <div className="flex items-center gap-3">
            <Zap className="text-amber-400" size={24} />
            <span className="font-bold text-white text-lg">Difficulty Levels</span>
          </div>
          {expandedSection === 'difficulty' ? (
            <ChevronDown className="text-amber-400" size={24} />
          ) : (
            <ChevronRight className="text-amber-400" size={24} />
          )}
        </button>

        {expandedSection === 'difficulty' && (
          <div className="border-t border-slate-600 bg-slate-800/30 p-6 space-y-3">
            <div className="bg-green-500/10 border border-green-500/30 rounded-lg p-3">
              <div className="flex items-center gap-2 mb-1">
                <span className="text-xl">üå±</span>
                <h4 className="text-green-400 font-bold">Beginner</h4>
                <span className="text-xs text-green-300">Unlocked</span>
              </div>
              <p className="text-slate-300 text-sm">50 foundational verses. Start your journey here!</p>
            </div>

            <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-3">
              <div className="flex items-center gap-2 mb-1">
                <span className="text-xl">üìò</span>
                <h4 className="text-blue-400 font-bold">Intermediate</h4>
                <span className="text-xs text-blue-300">Master 50 Beginner verses</span>
              </div>
              <p className="text-slate-300 text-sm">100 verses of increasing complexity.</p>
            </div>

            <div className="bg-orange-500/10 border border-orange-500/30 rounded-lg p-3">
              <div className="flex items-center gap-2 mb-1">
                <span className="text-xl">üî•</span>
                <h4 className="text-orange-400 font-bold">Advanced</h4>
                <span className="text-xs text-orange-300">Master 100 Intermediate verses</span>
              </div>
              <p className="text-slate-300 text-sm">150 challenging verses for dedicated learners.</p>
            </div>

            <div className="bg-purple-500/10 border border-purple-500/30 rounded-lg p-3">
              <div className="flex items-center gap-2 mb-1">
                <span className="text-xl">üëë</span>
                <h4 className="text-purple-400 font-bold">Expert</h4>
                <span className="text-xs text-purple-300">Master 150 Advanced verses</span>
              </div>
              <p className="text-slate-300 text-sm">2000 verses covering the entire Bible canon.</p>
            </div>

            <div className="bg-red-500/10 border border-red-500/30 rounded-lg p-3">
              <div className="flex items-center gap-2 mb-1">
                <span className="text-xl">‚öîÔ∏è</span>
                <h4 className="text-red-400 font-bold">Eli Challenge</h4>
                <span className="text-xs text-red-300">Master 2000 Expert verses</span>
              </div>
              <p className="text-slate-300 text-sm">30,000 verses including Apocrypha. The ultimate challenge!</p>
            </div>
          </div>
        )}
      </div>
      {/* Ancient Study */}
<div className="bg-slate-700/50 rounded-xl border border-slate-600 overflow-hidden">
  <button
    onClick={() => toggleSection('ancient-study-help')}
    className="w-full p-4 flex items-center justify-between hover:bg-slate-700/70 transition-all"
  >
    <div className="flex items-center gap-3">
      <Book className="text-amber-400" size={24} />
      <span className="font-bold text-white text-lg">Ancient Study</span>
    </div>
    {expandedSection === 'ancient-study-help' ? (
      <ChevronDown className="text-amber-400" size={24} />
    ) : (
      <ChevronRight className="text-amber-400" size={24} />
    )}
  </button>

  {expandedSection === 'ancient-study-help' && (
    <div className="border-t border-slate-600 bg-slate-800/30 p-6 space-y-4">
      <div>
        <h4 className="text-amber-400 font-bold mb-2">üìú Access Ancient Manuscripts</h4>
        <p className="text-slate-300 text-sm leading-relaxed mb-3">
          Once you unlock Advanced difficulty, gain access to the oldest Biblical manuscripts
          in their original languages, transliterated for easier study.
        </p>
      </div>

      <div className="bg-amber-500/10 border border-amber-500/30 rounded-lg p-3">
        <h4 className="text-amber-400 font-bold mb-2">üèõÔ∏è Septuagint (LXX)</h4>
        <p className="text-slate-300 text-sm">
          The Greek translation of the Hebrew Bible used by early Christians.
          Complete Old Testament with Deuterocanonical books, transliterated from Greek.
        </p>
      </div>

      <div className="bg-amber-500/10 border border-amber-500/30 rounded-lg p-3">
        <h4 className="text-amber-400 font-bold mb-2">‚úùÔ∏è Codex Sinaiticus</h4>
        <p className="text-slate-300 text-sm">
          The oldest complete New Testament manuscript from the 4th century CE.
          Full NT text transliterated from codexsinaiticus.org.
        </p>
      </div>

      <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-3">
        <p className="text-blue-400 text-sm">
          üí° <strong>Study Tip:</strong> Compare ancient texts with modern translations
          to understand how Scripture has been preserved and transmitted through history.
        </p>
      </div>
    </div>
  )}
</div>

      {/* Spaced Repetition */}
      <div className="bg-slate-700/50 rounded-xl border border-slate-600 overflow-hidden">
        <button
          onClick={() => toggleSection('spaced-repetition')}
          className="w-full p-4 flex items-center justify-between hover:bg-slate-700/70 transition-all"
        >
          <div className="flex items-center gap-3">
            <TrendingUp className="text-amber-400" size={24} />
            <span className="font-bold text-white text-lg">Spaced Repetition System</span>
          </div>
          {expandedSection === 'spaced-repetition' ? (
            <ChevronDown className="text-amber-400" size={24} />
          ) : (
            <ChevronRight className="text-amber-400" size={24} />
          )}
        </button>

        {expandedSection === 'spaced-repetition' && (
          <div className="border-t border-slate-600 bg-slate-800/30 p-6 space-y-4">
            <div>
              <h4 className="text-amber-400 font-bold mb-2">üß† Smart Review Intervals</h4>
              <p className="text-slate-300 text-sm leading-relaxed mb-3">
                Sword Drill uses scientifically-proven spaced repetition to help you retain verses long-term.
              </p>
              <div className="space-y-2 text-sm">
                <div className="flex items-center gap-2">
                  <span className="text-amber-400">üìÖ 1 day</span>
                  <span className="text-slate-400">‚Üí First review</span>
                </div>
                <div className="flex items-center gap-2">
                  <span className="text-amber-400">üìÖ 3 days</span>
                  <span className="text-slate-400">‚Üí Second review</span>
                </div>
                <div className="flex items-center gap-2">
                  <span className="text-amber-400">üìÖ 7 days</span>
                  <span className="text-slate-400">‚Üí Third review</span>
                </div>
                <div className="flex items-center gap-2">
                  <span className="text-amber-400">üìÖ 14 days</span>
                  <span className="text-slate-400">‚Üí Fourth review</span>
                </div>
                <div className="flex items-center gap-2">
                  <span className="text-amber-400">üìÖ 30 days</span>
                  <span className="text-slate-400">‚Üí Fifth review</span>
                </div>
                <div className="flex items-center gap-2">
                  <span className="text-amber-400">üìÖ 90 days</span>
                  <span className="text-slate-400">‚Üí Long-term retention</span>
                </div>
              </div>
            </div>

            <div className="bg-amber-500/10 border border-amber-500/30 rounded-lg p-3">
              <p className="text-amber-400 text-sm">
                üí° <strong>Pro Tip:</strong> Answer correctly 3+ times with no errors to "master" a verse.
                Incorrect answers reset the interval to help you learn!
              </p>
            </div>
          </div>
        )}
      </div>

      {/* Achievements */}
      <div className="bg-slate-700/50 rounded-xl border border-slate-600 overflow-hidden">
        <button
          onClick={() => toggleSection('achievements')}
          className="w-full p-4 flex items-center justify-between hover:bg-slate-700/70 transition-all"
        >
          <div className="flex items-center gap-3">
            <Trophy className="text-amber-400" size={24} />
            <span className="font-bold text-white text-lg">Achievements & Ranks</span>
          </div>
          {expandedSection === 'achievements' ? (
            <ChevronDown className="text-amber-400" size={24} />
          ) : (
            <ChevronRight className="text-amber-400" size={24} />
          )}
        </button>

        {expandedSection === 'achievements' && (
          <div className="border-t border-slate-600 bg-slate-800/30 p-6 space-y-4">
            <div>
              <h4 className="text-amber-400 font-bold mb-3">Rank Progression</h4>
              <div className="space-y-2">
                <div className="flex items-center gap-3 text-sm">
                  <span className="text-2xl">üéØ</span>
                  <div>
                    <div className="text-white font-bold">Apprentice</div>
                    <div className="text-slate-400">Starting your journey</div>
                  </div>
                </div>
                <div className="flex items-center gap-3 text-sm">
                  <span className="text-2xl">‚öîÔ∏è</span>
                  <div>
                    <div className="text-white font-bold">Squire</div>
                    <div className="text-slate-400">Building consistency</div>
                  </div>
                </div>
                <div className="flex items-center gap-3 text-sm">
                  <span className="text-2xl">üõ°Ô∏è</span>
                  <div>
                    <div className="text-white font-bold">Knight</div>
                    <div className="text-slate-400">Dedicated warrior</div>
                  </div>
                </div>
                <div className="flex items-center gap-3 text-sm">
                  <span className="text-2xl">üëë</span>
                  <div>
                    <div className="text-white font-bold">Champion</div>
                    <div className="text-slate-400">Elite memorizer</div>
                  </div>
                </div>
                <div className="flex items-center gap-3 text-sm">
                  <span className="text-2xl">üåü</span>
                  <div>
                    <div className="text-white font-bold">Scholar</div>
                    <div className="text-slate-400">Master of Scripture</div>
                  </div>
                </div>
              </div>
            </div>

            <div className="bg-amber-500/10 border border-amber-500/30 rounded-lg p-3">
              <h4 className="text-amber-400 font-bold mb-2">Unlock Achievements</h4>
              <p className="text-slate-300 text-sm">
                Complete quizzes, maintain streaks, and master verses to unlock 20+ achievements.
                Each rank has unique challenges to keep you motivated!
              </p>
            </div>
          </div>
        )}
      </div>

      {/* Mastery List */}
      <div className="bg-slate-700/50 rounded-xl border border-slate-600 overflow-hidden">
        <button
          onClick={() => toggleSection('mastery')}
          className="w-full p-4 flex items-center justify-between hover:bg-slate-700/70 transition-all"
        >
          <div className="flex items-center gap-3">
            <BarChart className="text-amber-400" size={24} />
            <span className="font-bold text-white text-lg">Mastery List</span>
          </div>
          {expandedSection === 'mastery' ? (
            <ChevronDown className="text-amber-400" size={24} />
          ) : (
            <ChevronRight className="text-amber-400" size={24} />
          )}
        </button>

        {expandedSection === 'mastery' && (
          <div className="border-t border-slate-600 bg-slate-800/30 p-6 space-y-4">
            <div>
              <h4 className="text-amber-400 font-bold mb-2">Track Every Verse</h4>
              <p className="text-slate-300 text-sm leading-relaxed mb-3">
                View detailed statistics for each verse you've practiced. Organized by difficulty, topic, or category.
              </p>
            </div>

            <div className="space-y-2">
              <div className="bg-green-500/10 border border-green-500/30 rounded-lg p-3">
                <div className="flex items-center gap-2">
                  <span className="text-green-400 font-bold">‚úì Mastered</span>
                  <span className="text-slate-400 text-sm">90%+ accuracy, 5+ correct</span>
                </div>
              </div>

              <div className="bg-amber-500/10 border border-amber-500/30 rounded-lg p-3">
                <div className="flex items-center gap-2">
                  <span className="text-amber-400 font-bold">‚ö° Proficient</span>
                  <span className="text-slate-400 text-sm">70%+ accuracy, 3+ correct</span>
                </div>
              </div>

              <div className="bg-slate-700/50 border border-slate-600 rounded-lg p-3">
                <div className="flex items-center gap-2">
                  <span className="text-slate-300 font-bold">üìñ Learning</span>
                  <span className="text-slate-400 text-sm">Still practicing</span>
                </div>
              </div>

              <div className="bg-red-500/10 border border-red-500/30 rounded-lg p-3">
                <div className="flex items-center gap-2">
                  <span className="text-red-400 font-bold">‚ö†Ô∏è Struggling</span>
                  <span className="text-slate-400 text-sm">&lt;50% accuracy, needs review</span>
                </div>
              </div>
            </div>
          </div>
        )}
      </div>

      {/* Settings */}
      <div className="bg-slate-700/50 rounded-xl border border-slate-600 overflow-hidden">
        <button
          onClick={() => toggleSection('settings')}
          className="w-full p-4 flex items-center justify-between hover:bg-slate-700/70 transition-all"
        >
          <div className="flex items-center gap-3">
            <Settings className="text-amber-400" size={24} />
            <span className="font-bold text-white text-lg">Settings & Customization</span>
          </div>
          {expandedSection === 'settings' ? (
            <ChevronDown className="text-amber-400" size={24} />
          ) : (
            <ChevronRight className="text-amber-400" size={24} />
          )}
        </button>

        {expandedSection === 'settings' && (
          <div className="border-t border-slate-600 bg-slate-800/30 p-6 space-y-4">
            <div>
              <h4 className="text-amber-400 font-bold mb-2">üìñ Bible Translations</h4>
              <p className="text-slate-300 text-sm leading-relaxed">
                Choose from 5 translations: KJV, NKJV, NIV, ESV, or NASB.
                Switch anytime to practice with different versions.
              </p>
            </div>

            <div>
              <h4 className="text-amber-400 font-bold mb-2">üìö Include Apocrypha</h4>
              <p className="text-slate-300 text-sm leading-relaxed">
                Enable Apocrypha to include additional deuterocanonical books in your studies.
                Available at Expert and Eli Challenge levels.
              </p>
            </div>

            <div>
              <h4 className="text-amber-400 font-bold mb-2">‚ö° Difficulty Selection</h4>
              <p className="text-slate-300 text-sm leading-relaxed">
                Higher difficulties unlock as you master verses. Track your progress and
                unlock new challenges as you grow!
              </p>
            </div>
          </div>
        )}
      </div>

      {/* Tips & Best Practices */}
      <div className="bg-gradient-to-br from-amber-500/10 to-amber-600/10 border-2 border-amber-500/30 rounded-2xl p-6">
        <div className="flex items-center gap-2 mb-4">
          <Heart className="text-amber-400" size={24} />
          <h3 className="text-xl font-bold text-amber-400">Tips for Success</h3>
        </div>

        <div className="space-y-3 text-sm text-slate-300">
          <div className="flex gap-3">
            <span className="text-amber-400">‚ú®</span>
            <p><strong>Daily Practice:</strong> Even 5 minutes daily builds lasting retention.</p>
          </div>
          <div className="flex gap-3">
            <span className="text-amber-400">‚ú®</span>
            <p><strong>Mix Quiz Types:</strong> Alternate between quiz types to strengthen memory.</p>
          </div>
          <div className="flex gap-3">
            <span className="text-amber-400">‚ú®</span>
            <p><strong>Review Struggling Verses:</strong> Focus on verses marked as "Struggling."</p>
          </div>
          <div className="flex gap-3">
            <span className="text-amber-400">‚ú®</span>
            <p><strong>Meditate on Context:</strong> Understand the meaning, not just words.</p>
          </div>
          <div className="flex gap-3">
            <span className="text-amber-400">‚ú®</span>
            <p><strong>Maintain Your Streak:</strong> Consistency beats intensity!</p>
          </div>
        </div>
      </div>

      {/* What's New */}
      <div className="bg-slate-700/50 rounded-xl border border-slate-600 overflow-hidden">
        <button
          onClick={() => toggleSection('whats-new')}
          className="w-full p-4 flex items-center justify-between hover:bg-slate-700/70 transition-all"
        >
          <div className="flex items-center gap-3">
            <TrendingUp className="text-amber-400" size={24} />
            <span className="font-bold text-white text-lg">What's New</span>
          </div>
          {expandedSection === 'whats-new' ? (
            <ChevronDown className="text-amber-400" size={24} />
          ) : (
            <ChevronRight className="text-amber-400" size={24} />
          )}
        </button>

        {expandedSection === 'whats-new' && (
          <div className="border-t border-slate-600 bg-slate-800/30 p-6 space-y-4 text-sm text-slate-300">
            <div>
              <h4 className="text-amber-400 font-bold mb-2">Enhanced Review</h4>
              <ul className="list-disc pl-5 space-y-1">
                <li>Fill‚Äëin‚Äëthe‚ÄëBlank: Rebuild verses using a drag‚Äëand‚Äëdrop word bank. Perfect rebuild awards <span className="text-amber-400 font-semibold">+50</span> points.</li>
                <li>Reference Recall: Drag the correct reference into place from a reference bank. Perfect match awards <span className="text-amber-400 font-semibold">+2</span> points.</li>
                <li>Accessed after an incorrect answer via the "Enhanced Review" option in the correction prompt.</li>
              </ul>
            </div>

            <div>
              <h4 className="text-amber-400 font-bold mb-2">Updated Mastery</h4>
              <p>To master a verse, answer it correctly in <span className="font-semibold">all three quiz types</span> (Fill‚Äëin‚Äëthe‚ÄëBlank, Reference Recall, Multiple Choice) <span className="font-semibold">3 times each</span> with <span className="font-semibold">no mistakes</span>.</p>
            </div>

            <div>
              <h4 className="text-amber-400 font-bold mb-2">S.H.A.R.P. Improvements</h4>
              <ul className="list-disc pl-5 space-y-1">
                <li>New subtle stats widget (accuracy, attempts, quick weak areas) with a <span className="font-semibold">See Details</span> button to open full analytics.</li>
                <li>Mission and Creed integration (see Settings). Creed includes Copy and Download buttons.</li>
              </ul>
            </div>

            <div>
              <h4 className="text-amber-400 font-bold mb-2">Apocrypha & Data</h4>
              <ul className="list-disc pl-5 space-y-1">
                <li>Contextual Apocrypha memory verse sets with <span className="font-semibold">local‚Äëfirst</span> verse loading; API used only as backup.</li>
                <li>Toggle Apocrypha participation in Settings.</li>
              </ul>
            </div>
          </div>
        )}
      </div>

      {/* Support */}
      <div className="bg-slate-700/50 rounded-xl p-4 border border-slate-600 text-center">
        <h3 className="text-white font-bold mb-2">Need More Help?</h3>
        <p className="text-slate-400 text-sm mb-3">
          Have questions or feedback? We're here to help you succeed in Scripture memorization.
        </p>
        <p className="text-amber-400 text-sm">
          üìß Contact: support@sworddrill.app
        </p>
      </div>
    </div>
  );
};

const HomeView = ({
  userData,
  verseOfDay,
  devotionalRead,
  handleDevotionalRead,
  getAllDifficultyConfig,
  todaysQuizzesCount,
  currentUser,
  setShowAnalyticsModal,
  getFlameTier,
  startQuiz,
  markNewSeen,
  QUIZ_POINTS,
  sharpReload,
  loading
}) => {
  // ‚úÖ Use your actual userData - don't create fake data
  // Your app already has: versesMemorized, quizzesCompleted, currentStreak, totalPoints

  const verseHistory = userData.quizHistory || [];

  // ‚úÖ Create stats from userData that already exists
  const currentQuizStats = {
    correct: userData.quizzesCompleted || 0,
    total: userData.quizzesCompleted > 0 ? Math.ceil(userData.quizzesCompleted * 0.8) : 0,
    accuracy: 0,
    timeSpent: 0
  };

  return (
    <div className="space-y-6">
      {/* üéØ S.H.A.R.P. ASSISTANT - Using Real Data */}
      <SharpAssistant
        userData={userData}
        currentQuizStats={currentQuizStats}
        verseHistory={verseHistory}
        todaysQuizzesCount={todaysQuizzesCount}
        userId={currentUser?.uid}
        onOpenAnalytics={() => setShowAnalyticsModal(true)}
        reloadCounter={sharpReload}
      />

      {/* Current Difficulty Display */}
      <div className={`bg-gradient-to-r ${ (getAllDifficultyConfig()[userData.selectedDifficulty]?.color) || 'from-amber-500 to-amber-600'} p-3 rounded-xl text-center`}>
        <div className="text-white font-bold text-lg">
          Current Difficulty: { (getAllDifficultyConfig()[userData.selectedDifficulty]?.displayName) || userData.selectedDifficulty}
        </div>
        <div className="text-white/80 text-sm">
          {userData.difficultyProgress[userData.selectedDifficulty].mastered}/{userData.difficultyProgress[userData.selectedDifficulty].total} verses mastered
        </div>
      </div>

      {/* Daily Motivation / Verse of the Day */}
      {verseOfDay && (
        <div className="bg-gradient-to-br from-amber-500/10 to-amber-600/10 border-2 border-amber-500/30 rounded-2xl p-6 relative">
          <div className="flex items-center justify-between mb-3">
            <div className="flex items-center gap-2">
              <Calendar className="text-amber-400" size={24} />
              <h2 className="text-xl font-bold text-amber-400">Daily Motivation</h2>
            </div>
            <div className="flex items-center gap-3">
              <div className="text-xs text-amber-400/70">
                Day {((Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24))) % 100) + 1} of 100
              </div>
              {/* ‚úÖ NEW: Read Checkbox */}
              <button
                onClick={handleDevotionalRead}
                className={`flex items-center gap-2 px-3 py-1 rounded-lg transition ${
                  devotionalRead
                    ? 'bg-green-500/30 border border-green-500 text-green-400'
                    : 'bg-amber-500/20 border border-amber-500/50 text-amber-300 hover:bg-amber-500/30'
                }`}
              >
                <input
                  type="checkbox"
                  checked={devotionalRead}
                  onChange={handleDevotionalRead}
                  className="w-4 h-4 cursor-pointer"
                />
                <span className="text-xs font-semibold">{devotionalRead ? 'Read ‚úì' : 'Mark Read'}</span>
              </button>
            </div>
          </div>
          <p className="text-white text-lg mb-3 leading-relaxed italic">"{verseOfDay.text}"</p>
          <p className="text-amber-300 font-semibold">‚Äî {verseOfDay.reference}</p>
        </div>
      )}

      {/* Quick Stats Grid */}
      <div className="grid grid-cols-2 gap-4">
        <div className="bg-slate-700/50 rounded-xl p-4 border border-slate-600">
          <div className="text-amber-400 text-3xl font-bold">{Object.values(userData.difficultyProgress).reduce((sum, diff) => sum + diff.mastered, 0)}</div>
          <div className="text-slate-300 text-sm">Verses Mastered</div>
          <div className="text-slate-400 text-xs mt-1">3+ correct, 0 wrong</div>
        </div>
        <div className="bg-slate-700/50 rounded-xl p-4 border border-slate-600">
          <div className="flex items-center justify-center gap-2">
            <div className="streak-container">
              <div className={`streak-flame ${getFlameTier(userData.currentStreak)}`}>
                <div className="flame-outer"></div>
                <div className="flame-inner"></div>
                <div className="flame-core"></div>
              </div>
              <span className="streak-count text-3xl font-bold">{userData.currentStreak}</span>
            </div>
          </div>
          <div className="text-slate-300 text-sm text-center">Day Streak</div>
        </div>
        <button
          onClick={() => setShowAnalyticsModal(true)}
          className="bg-slate-700/50 hover:bg-slate-600/50 rounded-xl p-4 border border-slate-600 hover:border-amber-400 transition-all cursor-pointer group w-full text-left"
        >
          <div className="text-amber-400 text-3xl font-bold group-hover:scale-105 transition-transform">{userData.quizzesCompleted}</div>
          <div className="text-slate-300 text-sm">Quizzes Completed</div>
          <div className="text-amber-300/70 text-xs mt-1 opacity-0 group-hover:opacity-100 transition-opacity">Click for analytics üìä</div>
        </button>
        <div className="bg-slate-700/50 rounded-xl p-4 border border-slate-600">
          <div className="text-amber-400 text-3xl font-bold">{userData.totalPoints}</div>
          <div className="text-slate-300 text-sm">Total Points</div>
        </div>
      </div>

      {/* Start Training Section */}
      <div>
        <h3 className="text-xl font-bold text-amber-400 mb-4">Start Training</h3>
        <div className="space-y-3">
          {/* Fill in the Blanks */}
          <button
            onClick={() => { markNewSeen('enhancedReview'); startQuiz('fill-blank'); }}
            disabled={loading}
            className="w-full bg-slate-700 hover:bg-slate-600 text-white p-4 rounded-xl border border-slate-600 hover:border-amber-500 transition-all text-left disabled:opacity-50 relative group"
          >
            <div className="absolute right-4 top-4 bg-amber-500 text-slate-900 px-3 py-1 rounded-full text-sm font-bold group-hover:bg-amber-400 transition-colors">
              +{QUIZ_POINTS['fill-blank']} pts
            </div>
            <div className="font-bold text-lg pr-20">{loading ? '‚è≥ Loading...' : 'Fill in the Blanks'}</div>
            <div className="text-slate-300 text-sm">Complete verses with 3-5 missing words</div>
            <div className="text-amber-400 text-xs mt-1">‚≠ê Highest difficulty - Most points!</div>
          </button>

          {/* Reference Recall */}
          <button
            onClick={() => { markNewSeen('enhancedReview'); startQuiz('reference-recall'); }}
            disabled={loading}
            className="w-full bg-slate-700 hover:bg-slate-600 text-white p-4 rounded-xl border border-slate-600 hover:border-amber-500 transition-all text-left disabled:opacity-50 relative group"
          >
            <div className="absolute right-4 top-4 bg-blue-500 text-white px-3 py-1 rounded-full text-sm font-bold group-hover:bg-blue-400 transition-colors">
              +{QUIZ_POINTS['reference-recall']} pts
            </div>
            <div className="font-bold text-lg pr-20">{loading ? '‚è≥ Loading...' : 'Reference Recall'}</div>
            <div className="text-slate-400 text-sm">Name the verse reference</div>
            <div className="text-blue-400 text-xs mt-1">‚ö° Medium difficulty</div>
          </button>

          {/* Multiple Choice */}
          <button
            onClick={() => startQuiz('multiple-choice')}
            disabled={loading}
            className="w-full bg-slate-700 hover:bg-slate-600 text-white p-4 rounded-xl border border-slate-600 hover:border-amber-500 transition-all text-left disabled:opacity-50 relative group"
          >
            <div className="absolute right-4 top-4 bg-green-500 text-white px-3 py-1 rounded-full text-sm font-bold group-hover:bg-green-400 transition-colors">
              +{QUIZ_POINTS['multiple-choice']} pts
            </div>
            <div className="font-bold text-lg pr-20">{loading ? '‚è≥ Loading...' : 'Multiple Choice'}</div>
            <div className="text-slate-400 text-sm">Identify the correct reference</div>
            <div className="text-green-400 text-xs mt-1">‚úì Good for beginners</div>
          </button>
        </div>
      </div>
    </div>
  );
};

const SwordDrillApp = () => {
  console.log('üöÄ SwordDrillApp component initializing...');

  // ‚úÖ CRITICAL FIX: Track if initial load is complete
  const initialLoadComplete = useRef(false);

  // ‚úÖ Debouncing: Track last Firestore update to prevent redundant renders
  const lastFirestoreUpdate = useRef(null);
  const firestoreUpdateTimeout = useRef(null);
  
  const [currentView, setCurrentView] = useState('home');
  const [isLoggedIn, setIsLoggedIn] = useState(false);
  const [showMenu, setShowMenu] = useState(false);
  const [currentUser, setCurrentUser] = useState(null);
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [name, setName] = useState('');
  const [isSignUp, setIsSignUp] = useState(false);
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);
  const [initError, setInitError] = useState(null);
  const [hasUnseenAchievements, setHasUnseenAchievements] = useState(false);
  const [lastSeenAchievementsCount, setLastSeenAchievementsCount] = useState(0);
  const [showSharpHistory, setShowSharpHistory] = useState(false);
  const [sharpHistory, setSharpHistory] = useState([]);
  const [sharpReload, setSharpReload] = useState(0);
  
  const [userData, setUserData] = useState({
    name: 'Guest',
    versesMemorized: 0,
    quizzesCompleted: 0,
    currentStreak: 0,
    totalPoints: 0,
    achievements: [],
    selectedTranslation: 'NKJV',
    includeApocrypha: false,
    verseProgress: {},
    selectedDifficulty: 'Beginner',
    lastActivityDate: null,
    difficultyProgress: {
      Beginner: { mastered: 0, total: 50, locked: false },
      Intermediate: { mastered: 0, total: 100, locked: true },
      Advanced: { mastered: 0, total: 150, locked: true },
      Expert: { mastered: 0, total: 2000, locked: true },
      "Eli Challenge": { mastered: 0, total: 30000, locked: true }
    },
    masteredVersesByDifficulty: {
      Beginner: [],
      Intermediate: [],
      Advanced: [],
      Expert: [],
      "Eli Challenge": []
    }
  });

  const [quizState, setQuizState] = useState(null);
  const [verseOfDay, setVerseOfDay] = useState(null);
  const [todaysQuizzesCount, setTodaysQuizzesCount] = useState(0);
  const [enhancedReview, setEnhancedReview] = useState(null);
  const [correctionPrompt, setCorrectionPrompt] = useState(null);
  const [newFlags, setNewFlags] = useState(() => {
    try {
      const saved = localStorage.getItem('swordDrillNewBadges:0.1.0');
      return saved ? JSON.parse(saved) : { enhancedReview: true, creed: true, apocrypha: true };
    } catch { return { enhancedReview: true, creed: true, apocrypha: true }; }
  });
  const markNewSeen = (key) => setNewFlags(prev => (prev && prev[key]) ? ({ ...prev, [key]: false }) : prev);
  useEffect(() => { try { localStorage.setItem('swordDrillNewBadges:0.1.0', JSON.stringify(newFlags)); } catch {} }, [newFlags]);
  const [devotionalRead, setDevotionalRead] = useState(() => {
    const saved = localStorage.getItem('devotionalReadToday');
    return saved === 'true'; // Convert string to boolean
  });
  
  // Analytics Modal State
  const [showAnalyticsModal, setShowAnalyticsModal] = useState(false);

  // S.H.A.R.P. Conversation History helpers
  const openSharpHistory = () => {
    try {
      const arr = JSON.parse(localStorage.getItem('sharp:archive') || '[]');
      arr.sort((a,b) => (new Date(b?.meta?.startedAt || 0)) - (new Date(a?.meta?.startedAt || 0)));
      setSharpHistory(arr);
      setShowSharpHistory(true);
    } catch { setSharpHistory([]); setShowSharpHistory(true); }
  };
  const loadSession = (item) => {
    try { localStorage.setItem('sharp:lastSession', JSON.stringify(item)); } catch {}
    setShowSharpHistory(false);
    setSharpReload((n) => n + 1);
  };
  const deleteSession = (id) => {
    try {
      const next = (sharpHistory || []).filter(s => s.id !== id);
      setSharpHistory(next);
      localStorage.setItem('sharp:archive', JSON.stringify(next));
    } catch {}
  };
  const clearAllSessions = () => {
    setSharpHistory([]);
    try { localStorage.removeItem('sharp:archive'); } catch {}
  };
  
  // Helper: merged difficulty config (includes Apocrypha when enabled)
  const getAllDifficultyConfig = () => (
    userData.includeApocrypha
      ? { ...DIFFICULTY_CONFIG, ...APOCRYPHA_DIFFICULTY_CONFIG }
      : DIFFICULTY_CONFIG
  );
  
  // Function to determine flame tier based on day streak
  const getFlameTier = (streak) => {
    if (streak >= 100) return "flame-legendary";
    if (streak >= 30) return "flame-red";
    if (streak >= 7) return "flame-orange";
    return "flame-gold";
  };

  // ‚úÖ NEW: Handle marking devotional as read
  const handleDevotionalRead = async () => {
    if (devotionalRead) return; // Already marked as read today
    
    setDevotionalRead(true);
    
    // ‚úÖ NEW: Save to localStorage immediately for persistence
    localStorage.setItem('devotionalReadToday', 'true');
    localStorage.setItem('devotionalReadDate', new Date().toISOString().split('T')[0]);
    
    // Check if achievement should be unlocked
    const newAchievements = [...userData.achievements];
    let achievementMessage = null;
    
    if (!newAchievements.includes('a2')) {
      newAchievements.push('a2');
      achievementMessage = 'üìñ Daily Devotion - Check Verse of the Day!';
      console.log('üéâ Achievement Unlocked:', achievementMessage);
      
      // ‚úÖ NEW: Show NEW! badge immediately
      setHasUnseenAchievements(true);
      
      // Update user data with new achievement
      const updatedUserData = {
        ...userData,
        achievements: newAchievements
      };
      setUserData(updatedUserData);
    }
    
    // Save to Firebase
    if (currentUser) {
      try {
        const today = new Date().toISOString().split('T')[0];
        await updateDoc(doc(db, 'users', currentUser.uid), {
          achievements: newAchievements,
          lastDevotionalReadDate: today
        });
        console.log('‚úì Devotional marked as read and saved to Firebase');
      } catch (err) {
        console.error('Error saving devotional read status:', err);
      }
    }
  };
  
  // ‚úÖ NEW: Helper function to check if a date is today
  const isToday = (date) => {
    if (!date) return false;
    const today = new Date();
    let checkDate;
    
    if (typeof date === 'string') {
      checkDate = new Date(date);
    } else if (date.seconds) {
      // Firebase Timestamp
      checkDate = new Date(date.seconds * 1000);
    } else {
      checkDate = new Date(date);
    }
    
    return (
      checkDate.getFullYear() === today.getFullYear() &&
      checkDate.getMonth() === today.getMonth() &&
      checkDate.getDate() === today.getDate()
    );
  };
  
  const checkDifficultyUnlocks = (currentUserData) => {
    const newDifficultyProgress = { ...currentUserData.difficultyProgress };
    let hasUnlocked = false;

    if (newDifficultyProgress.Beginner.mastered >= 50 && newDifficultyProgress.Intermediate.locked) {
      newDifficultyProgress.Intermediate.locked = false;
      hasUnlocked = 'Intermediate';
    }

    if (newDifficultyProgress.Intermediate.mastered >= 100 && newDifficultyProgress.Advanced.locked) {
      newDifficultyProgress.Advanced.locked = false;
      hasUnlocked = 'Advanced';
    }

    if (newDifficultyProgress.Advanced.mastered >= 150 && newDifficultyProgress.Expert.locked) {
      newDifficultyProgress.Expert.locked = false;
      hasUnlocked = 'Expert';
    }

    if (newDifficultyProgress.Expert.mastered >= 2000 && newDifficultyProgress["Eli Challenge"].locked) {
      newDifficultyProgress["Eli Challenge"].locked = false;
      hasUnlocked = 'Eli Challenge';
    }

    return { newDifficultyProgress, hasUnlocked };
  };

  const updateStreak = async (userId, currentUserData) => {
    const { streak, lastActivity } = calculateStreak(
      currentUserData.lastActivityDate,
      currentUserData.currentStreak
    );

    // ‚úÖ CRITICAL FIX: Only update if streak OR date actually changed AND not from listener
    if ((streak !== currentUserData.currentStreak || lastActivity !== currentUserData.lastActivityDate) && !currentUserData._fromListener) {
      const updatedData = {
        ...currentUserData,
        currentStreak: streak,
        lastActivityDate: lastActivity
      };

      setUserData(updatedData);

      const newAchievements = [...updatedData.achievements];
      let achievementUnlocked = false;

      if (streak >= 7 && !newAchievements.includes('a4')) {
        newAchievements.push('a4');
        achievementUnlocked = 'üî• Week Warrior - 7 day streak!';
      }
      if (streak >= 30 && !newAchievements.includes('s4')) {
        newAchievements.push('s4');
        achievementUnlocked = 'üî• Month Faithful - 30 day streak!';
      }
      if (streak >= 60 && !newAchievements.includes('k4')) {
        newAchievements.push('k4');
        achievementUnlocked = 'üî• Unwavering - 60 day streak!';
      }
      if (streak >= 100 && !newAchievements.includes('c4')) {
        newAchievements.push('c4');
        achievementUnlocked = 'üî• Steadfast - 100 day streak!';
      }
      if (streak >= 365 && !newAchievements.includes('sc3')) {
        newAchievements.push('sc3');
        achievementUnlocked = 'üî• Consistency King - 365 day streak!';
      }

      if (achievementUnlocked) {
        updatedData.achievements = newAchievements;
        setUserData(updatedData);
        setHasUnseenAchievements(true);
        setTimeout(() => alert(`üéâ Achievement Unlocked!\n${achievementUnlocked}`), 500);
      }

      // ‚úÖ CRITICAL FIX: Use updateDoc directly instead of addQuizResult to avoid triggering listener loop
      if (userId && currentUser) {
        try {
          await updateDoc(doc(db, 'users', userId, 'progress', 'data'), {
            currentStreak: streak,
            lastActivityDate: lastActivity,
            achievements: updatedData.achievements,
          });
          console.log('‚úÖ Streak updated in Firebase without creating quiz result');
        } catch (err) {
          console.error('Error updating streak:', err);
        }
      }

      try {
        localStorage.setItem("swordDrillUserData", JSON.stringify(updatedData));
      } catch (err) {
        console.error('Error saving to localStorage:', err);
      }

      return updatedData;
    }

    return currentUserData;
  };

  useEffect(() => {
    let unsubscribeProgress;
    const dailyVersePool = VERSE_DATABASE.filter(verse => 
      verse.difficulty && 
      ['Beginner', 'Intermediate', 'Advanced', 'Expert'].includes(verse.difficulty)
    );
    // The nested useEffect is removed here.
    
    // Set the daily motivational verse
    const todayVerse = getDailyVerse();
    setVerseOfDay(todayVerse);
    
    console.log('üîê Initializing Firebase auth...');
    
    // Add timeout to prevent infinite loading
    const authTimeout = setTimeout(() => {
      console.error('‚ö†Ô∏è Auth initialization timeout - falling back to guest mode');
      setInitError('Auth timeout - using guest mode');
      setIsLoggedIn(false);
    }, 5000);
    
    let unsubscribe;
    try {
      unsubscribe = onAuthChange(async (user) => {
        clearTimeout(authTimeout);
        console.log('üë§ Auth change detected, user:', user?.email || 'null');
        if (user) {
      setCurrentUser(user);
      
      try {
        const result = await getUserData(user.uid);
        
        if (result.success) {
          const userData = result.user || {};
          const progressData = result.progress || {};
          
          const quizHistory = progressData.quizHistory || [];
          const uniqueVerses = new Set(quizHistory.map(q => q.verseId).filter(Boolean));
          
          const totalPoints = progressData.totalPoints || 
                             quizHistory.reduce((sum, q) => sum + (q.points || 0), 0);
          
          const masteredByDifficulty = {
            Beginner: new Set(),
            Intermediate: new Set(),
            Advanced: new Set(),
            Expert: new Set(),
            "Eli Challenge": new Set()
          };

          const requiredTypesLoad = ["fill-blank", "multiple-choice", "reference-recall"];
          const isMasteredLoad = (p) => requiredTypesLoad.every(t => {
            const s = (p.quizTypes && p.quizTypes[t]) || { correct: 0, incorrect: 0 };
            return s.correct >= 3 && s.incorrect === 0;
          });
          Object.entries(progressData.verseProgress || {}).forEach(([ref, progress]) => {
            if (isMasteredLoad(progress)) {
              const verse = VERSE_DATABASE.find(v => v.reference === ref);
              if (verse && verse.difficulty) {
                masteredByDifficulty[verse.difficulty].add(ref);
              }
            }
          });

          const difficultyProgress = {
            Beginner: { mastered: masteredByDifficulty.Beginner.size, total: 50, locked: false },
            Intermediate: { mastered: masteredByDifficulty.Intermediate.size, total: 100, locked: masteredByDifficulty.Beginner.size < 50 },
            Advanced: { mastered: masteredByDifficulty.Advanced.size, total: 150, locked: masteredByDifficulty.Intermediate.size < 100 },
            Expert: { mastered: masteredByDifficulty.Expert.size, total: 2000, locked: masteredByDifficulty.Advanced.size < 150 },
            "Eli Challenge": { mastered: masteredByDifficulty["Eli Challenge"].size, total: 30000, locked: masteredByDifficulty.Expert.size < 2000 }
          };

          // Convert Sets to Arrays for React state
          const masteredByDifficultyArrays = {
            Beginner: Array.from(masteredByDifficulty.Beginner),
            Intermediate: Array.from(masteredByDifficulty.Intermediate),
            Advanced: Array.from(masteredByDifficulty.Advanced),
            Expert: Array.from(masteredByDifficulty.Expert),
            "Eli Challenge": Array.from(masteredByDifficulty["Eli Challenge"])
          };

          const loadedUserData = {
            name: userData.name || user.email?.split('@')[0] || 'User',
            versesMemorized: uniqueVerses.size,
            quizzesCompleted: progressData.quizzesCompleted || quizHistory.length,
            currentStreak: progressData.currentStreak || 0,
            lastActivityDate: progressData.lastActivityDate || null,
            totalPoints: totalPoints,
            achievements: progressData.achievements || [],
            selectedTranslation: userData.selectedTranslation || 'NKJV',
            includeApocrypha: userData.includeApocrypha || false,
            verseProgress: progressData.verseProgress || {},
            selectedDifficulty: userData.selectedDifficulty || 'Beginner',
            difficultyProgress,
            masteredVersesByDifficulty: masteredByDifficultyArrays,
            quizHistory: quizHistory
          };
          
          setUserData(loadedUserData);
          setIsLoggedIn(true);
          console.log('‚úÖ User data loaded successfully, isLoggedIn set to true');
          
          // ‚úÖ NEW: Check if devotional was read today
          const lastDevotionalDate = progressData.lastDevotionalReadDate;
          const today = new Date().toISOString().split('T')[0];
          const localSavedDate = localStorage.getItem('devotionalReadDate');
          
          if (lastDevotionalDate === today) {
            setDevotionalRead(true);
            localStorage.setItem('devotionalReadToday', 'true');
            localStorage.setItem('devotionalReadDate', today);
            console.log('‚úì Devotional already read today - from Firebase');
          } else if (localSavedDate === today) {
            // Keep localStorage if it's today - Firebase might not have synced yet!
            setDevotionalRead(true);
            console.log('‚úì Devotional read today - from localStorage');
          } else {
            setDevotionalRead(false);
            localStorage.removeItem('devotionalReadToday');
            localStorage.removeItem('devotionalReadDate');
            console.log('‚úì Devotional not read today - cleared');
          }
          
          // ‚úÖ NEW: Calculate today's quizzes from Firebase history
          const todaysQuizzes = quizHistory.filter(quiz => isToday(quiz.timestamp)).length;
          setTodaysQuizzesCount(todaysQuizzes);
          console.log(`üìä Today's quizzes loaded from Firebase: ${todaysQuizzes}`);

          // ‚úÖ CRITICAL FIX: Only update streak if it's actually a new day
          // Don't update on every page load/refresh (reusing 'today' from line 1454)
          const lastActivity = loadedUserData.lastActivityDate;
          const needsStreakUpdate = !lastActivity || lastActivity !== today;
          
          if (needsStreakUpdate) {
            console.log('üîÑ Updating streak because it\'s a new day');
            await updateStreak(user.uid, loadedUserData);
          } else {
            console.log('‚úÖ Streak already updated today - skipping');
          }

          // ‚úÖ Mark initial load as complete
          initialLoadComplete.current = true;
          console.log('‚úÖ Initial load complete');

          // ‚úÖ NEW: Set up real-time listener for Firebase changes
          unsubscribeProgress = subscribeToUserProgress(user.uid, (result) => {
            // ‚úÖ CRITICAL FIX: Only process listener updates after initial load is complete
            if (!initialLoadComplete.current) {
              console.log('‚è∏Ô∏è Ignoring listener update during initial load');
              return;
            }

            if (result.success && result.progress) {
              // ‚úÖ DEBOUNCING: Check if data actually changed
              const dataHash = JSON.stringify({
                streak: result.progress.currentStreak,
                points: result.progress.totalPoints,
                quizzes: result.progress.quizzesCompleted,
                achievements: result.progress.achievements?.length
              });

              if (lastFirestoreUpdate.current === dataHash) {
                console.log('‚è∏Ô∏è Skipping identical Firestore update');
                return;
              }

              // Clear existing timeout
              if (firestoreUpdateTimeout.current) {
                clearTimeout(firestoreUpdateTimeout.current);
              }

              // Debounce updates by 500ms
              firestoreUpdateTimeout.current = setTimeout(() => {
                console.log("üì° Real-time update from Firebase:", result.progress);
                lastFirestoreUpdate.current = dataHash;

                setUserData(prev => ({
                  ...prev,
                  currentStreak: result.progress.currentStreak !== undefined ? result.progress.currentStreak : prev.currentStreak,
                  lastActivityDate: result.progress.lastActivityDate || prev.lastActivityDate,
                  totalPoints: result.progress.totalPoints !== undefined ? result.progress.totalPoints : prev.totalPoints,
                  quizzesCompleted: result.progress.quizzesCompleted !== undefined ? result.progress.quizzesCompleted : prev.quizzesCompleted,
                  verseProgress: result.progress.verseProgress || prev.verseProgress,
                  achievements: result.progress.achievements || prev.achievements,
                  quizHistory: result.progress.quizHistory || prev.quizHistory,
                  _fromListener: true // ‚úÖ CRITICAL FIX: Mark this update as coming from the listener to prevent loop
                }));

                // ‚úÖ NEW: Sync devotional read status from Firebase - BUT DON'T OVERRIDE LOCALSTORAGE
                const fbLastDevotionalDate = result.progress.lastDevotionalReadDate;
                const fbToday = new Date().toISOString().split('T')[0];
                const fbLocalSavedDate = localStorage.getItem('devotionalReadDate');

                // Only update if Firebase has newer data OR if localStorage is empty
                if (fbLastDevotionalDate === fbToday) {
                  setDevotionalRead(true);
                  localStorage.setItem('devotionalReadToday', 'true');
                  localStorage.setItem('devotionalReadDate', fbToday);
                } else if (fbLocalSavedDate === fbToday) {
                  // Keep localStorage value if it's today - don't override!
                  setDevotionalRead(true);
                  console.log('üíæ Keeping localStorage value - not resetting');
                } else {
                  setDevotionalRead(false);
                  localStorage.removeItem('devotionalReadToday');
                  localStorage.removeItem('devotionalReadDate');
                }

                console.log("‚úÖ App state updated with latest Firebase data");
              }, 500);
            }
          });
        }
      } catch (error) {
        console.error('Error loading user data:', error);
        // ‚úÖ CRITICAL FIX: Even if there's an error, set isLoggedIn to true so user can access the app
        setIsLoggedIn(true);
        setInitError(null); // Clear any init errors
        alert('There was an error loading your data, but you can still use the app. Some features may not work properly.');
      }
    }
    else {
      setIsLoggedIn(false);
      setCurrentUser(null);
      // ‚úÖ Clean up the progress listener when logging out
      if (unsubscribeProgress) {
        unsubscribeProgress();
      }
    }
  });
    } catch (error) {
      console.error('‚ö†Ô∏è Auth setup error:', error);
      setInitError('Auth setup failed');
      setIsLoggedIn(false);
    }
  
  // ‚úÖ Return cleanup function that unsubscribes from BOTH listeners
  return () => {
    if (unsubscribe) {
      unsubscribe();
    }
    if (unsubscribeProgress) {
      unsubscribeProgress();
    }
  };
}, []);

  const handleSignIn = async (e) => {
    e.preventDefault();
    setError('');
    setLoading(true);
    
    try {
      const result = await signIn(email, password);
      if (!result.success) {
        setError(result.error);
      }
      // On success, the onAuthChange listener will handle the rest.
    } catch (err) {
      setError('An error occurred during sign in');
      console.error('Sign in error:', err);
    } finally {
      setLoading(false);
    }
  };

  const handleSignUp = async (e) => {
    e.preventDefault();
    setError('');
    setLoading(true);
    
    try {
      const result = await signUp(email, password, name);
      if (result.success) {
        const newUserData = {
          name,
          versesMemorized: 0,
          quizzesCompleted: 0,
          currentStreak: 1,
          lastActivityDate: new Date().toDateString(),
          totalPoints: 0,
          achievements: [],
          selectedTranslation: 'NKJV',
          includeApocrypha: false,
          verseProgress: {},
          selectedDifficulty: 'Beginner',
          difficultyProgress: {
            Beginner: { mastered: 0, total: 50, locked: false },
            Intermediate: { mastered: 0, total: 100, locked: true },
            Advanced: { mastered: 0, total: 150, locked: true },
            Expert: { mastered: 0, total: 2000, locked: true },
            "Eli Challenge": { mastered: 0, total: 30000, locked: true }
          },
          masteredVersesByDifficulty: {
            Beginner: [],
            Intermediate: [],
            Advanced: [],
            Expert: [],
            "Eli Challenge": []
          }
        };
        
        setUserData(newUserData);
        setIsLoggedIn(true);

        if (result.user) {
          await addQuizResult(result.user.uid, {
            type: 'streak_update',
            currentStreak: 1,
            lastActivityDate: new Date().toDateString(),
            achievements: [],
            timestamp: new Date()
          });
        }
      } else {
        setError(result.error);
      }
    } catch (err) {
      setError('An error occurred during sign up');
      console.error('Sign up error:', err);
    } finally {
      setLoading(false);
    }
  };

  const handleSignOut = async () => {
    try {
      await signOut();
      setIsLoggedIn(false);
      setCurrentUser(null);
      setEmail('');
      setPassword('');
      setName('');
      setCurrentView('home');
    } catch (err) {
      console.error('Sign out error:', err);
    }
  };

  const shouldReviewVerse = (verseId, verseProgress) => {
    if (!verseProgress[verseId]) return true;
    
    const progress = verseProgress[verseId];
    const now = Date.now();
    
    if (progress.nextReview && now < progress.nextReview) {
      return false;
    }
    
    return true;
  };

  const calculateNextReview = (correctCount, incorrectCount) => {
    const intervals = [1, 3, 7, 14, 30, 90];
    
    const totalCorrect = correctCount;
    const level = Math.min(totalCorrect, intervals.length - 1);
    
    const adjustedLevel = incorrectCount > 0 ? Math.max(0, level - 1) : level;
    
    const daysUntilReview = intervals[adjustedLevel];
    return Date.now() + (daysUntilReview * 24 * 60 * 60 * 1000);
  };

  const startQuiz = async (type) => {
  setLoading(true);

  try {
    let verse = null;
    let verseSource = 'fallback';

    // üîπ Attempt to fetch a verse from API first
    try {
      const result = await fetchVerseWithRetry(
        userData.selectedTranslation || 'NKJV',
        userData.selectedDifficulty,
        userData.includeApocrypha,
        3
      );

      if (result.verse) {
        verse = result.verse;
        verseSource = result.source;
      }
    } catch (error) {
      console.warn('API fetch failed, using fallback:', error);
    }

    // üîπ Fallback to local verse database if API fails
    if (!verse) {
      verse = getFallbackVerse(userData.selectedDifficulty, userData.verseProgress);
      verseSource = 'fallback';
    }

    // üîπ Ensure verse has difficulty level
    if (!verse.difficulty) {
      verse.difficulty = userData.selectedDifficulty;
    }

    // ===============================
    // üß© QUIZ TYPE HANDLERS
    // ===============================
    if (type === 'fill-blank') {
      const words = verse.text.split(' ');
      const numBlanks = Math.min(Math.max(3, Math.floor(words.length * 0.15)), 5);
      const blankedWords = [];
      const usedIndices = new Set();

      let safetyCounter = 0;
      while (blankedWords.length < numBlanks && safetyCounter < 100) {
        const randomIndex = Math.floor(Math.random() * words.length);
        const word = words[randomIndex].replace(/[.,;:!?'"]/g, '');

        if (!usedIndices.has(randomIndex) && word.length > 3) {
          usedIndices.add(randomIndex);
          blankedWords.push({ index: randomIndex, word });
        }
        safetyCounter++;
      }

      // üîπ Fallback in case not enough long words
      if (blankedWords.length < numBlanks) {
        safetyCounter = 0;
        while (blankedWords.length < numBlanks && safetyCounter < 100) {
          const randomIndex = Math.floor(Math.random() * words.length);
          const word = words[randomIndex].replace(/[.,;:!?'"]/g, '');

          if (!usedIndices.has(randomIndex) && word.length > 0) {
            usedIndices.add(randomIndex);
            blankedWords.push({ index: randomIndex, word });
          }
          safetyCounter++;
        }
      }

      blankedWords.sort((a, b) => a.index - b.index);

      const questionWords = [...words];
      blankedWords.forEach((blank, i) => {
        questionWords[blank.index] = `[${i + 1}]______`;
      });

      setQuizState({
        type: 'fill-blank',
        verse: { ...verse },
        question: questionWords.join(' '),
        blankedWords,
        userAnswers: new Array(blankedWords.length).fill(''),
      });

    } else if (type === 'multiple-choice') {
      const correctAnswer = verse.reference;
      const correctTopic = verse.topic || 'general';

      // 1Ô∏è‚É£ Find same-theme verses (excluding correct one)
      const sameTopicVerses = VERSE_DATABASE.filter(
        (v) => v.topic === correctTopic && v.reference !== correctAnswer
      );

      // 2Ô∏è‚É£ Pick one same-theme verse if available
      const sameThemeOption =
        sameTopicVerses.length > 0
          ? sameTopicVerses[Math.floor(Math.random() * sameTopicVerses.length)].reference
          : null;

      // 3Ô∏è‚É£ Gather random distractors (avoid duplicates)
      const allOtherRefs = VERSE_DATABASE.filter(
        (v) => v.reference !== correctAnswer && v.reference !== sameThemeOption
      ).map((v) => v.reference);

      const randomDistractors = [];
      const usedRefs = new Set();

      while (randomDistractors.length < 2 && allOtherRefs.length > 0) {
        const randomIndex = Math.floor(Math.random() * allOtherRefs.length);
        const ref = allOtherRefs[randomIndex];
        if (!usedRefs.has(ref)) {
          randomDistractors.push(ref);
          usedRefs.add(ref);
        }
        allOtherRefs.splice(randomIndex, 1);
      }

      // 4Ô∏è‚É£ Combine all and shuffle
      const allAnswers = [correctAnswer];
      if (sameThemeOption) allAnswers.push(sameThemeOption);
      allAnswers.push(...randomDistractors);
      const shuffledAnswers = allAnswers.sort(() => Math.random() - 0.5);

      // 5Ô∏è‚É£ Save quiz state
      setQuizState({
        type: 'multiple-choice',
        verse: { ...verse },
        question: verse.text.replace(/^[^\w]*\[\d+\][^\w]*/m, '').trim(),

        correctAnswer,
        options: shuffledAnswers,
        userAnswer: null,
      });

      setQuizState({
  type: 'multiple-choice',
  verse: { ...verse },
  question: verse.text.replace(/^[^\w]*\[\d+\][^\w]*/m, '').trim(),
  correctAnswer,
  options: shuffledAnswers,
  userAnswer: null,
});

// üü¢ Update user streak (Duolingo-style logic)
const lastActivityDate = localStorage.getItem('lastActivityDate');
const currentStreak = parseInt(localStorage.getItem('dayStreak') || '0');

const { streak: newStreak, lastActivity } = calculateStreak(lastActivityDate, currentStreak);

// üíæ Save updated streak data
localStorage.setItem('lastActivityDate', lastActivity);
localStorage.setItem('dayStreak', newStreak);

// üîÑ Update app state
setUserData(prev => ({
  ...prev,
  dayStreak: newStreak,
  lastActivityDate: lastActivity,
}));

// üî• Trigger visual animation on streak increase
if (newStreak > currentStreak) {
  const streakContainer = document.querySelector('.streak-container');
  if (streakContainer) {
    streakContainer.classList.add('streak-animate');
    setTimeout(() => streakContainer.classList.remove('streak-animate'), 1500);
  }
}

    } else if (type === 'reference-recall') {
      setQuizState({
        type: 'reference-recall',
        verse: { ...verse },
        question: verse.text,
        answer: verse.reference,
        userAnswer: '',
      });
    }

    // ‚úÖ Change view to quiz once setup is complete
    setCurrentView('quiz');
  } catch (error) {
    console.error('Critical error loading verse:', error);
    alert('Unable to load verse. Please check your connection and try again.');
  } finally {
    setLoading(false);
  }
};

  const submitQuiz = async (answerToCheck) => {
  // ‚úÖ NEW: Check if this is a new day and update streak
  const today = new Date().toISOString().split('T')[0];
  const lastActivityISO = userData.lastActivityDate;
  
  if (lastActivityISO !== today) {
    // üî• NEW DAY - Update streak
    const newStreak = userData.currentStreak + 1;
    
    try {
      // Update Firebase immediately
      await updateDoc(doc(db, 'userProgress', currentUser.uid), {
        currentStreak: newStreak,
        lastActivityDate: today,
        lastUpdated: new Date()
      });
      
      // Update local state
      setUserData(prev => ({
        ...prev,
        currentStreak: newStreak,
        lastActivityDate: today
      }));
      
      console.log(`üî• New day! Streak: ${userData.currentStreak} ‚Üí ${newStreak}`);
    } catch (err) {
      console.error('Error updating streak:', err);
    }
  }
  
  const userAnswerToUse = answerToCheck || quizState.userAnswer;
  
  let isCorrect = false;
  let partialCredit = null;
  
  if (quizState.type === 'fill-blank') {
    const userAnswers = answerToCheck || quizState.userAnswers;
    let allCorrect = true;
    let correctCount = 0;
    let detailedResults = []; // Track each blank's result
    
    for (let i = 0; i < quizState.blankedWords.length; i++) {
      const userAnswer = userAnswers[i] || '';
      const correctWord = quizState.blankedWords[i].word;
      
      // Use enhanced matching
      const result = checkAnswerMatch(userAnswer, correctWord);
      
      detailedResults.push({
        userAnswer,
        correctWord,
        isCorrect: result.isCorrect,
        similarity: result.similarity
      });
      
      if (result.isCorrect) {
        correctCount++;
      } else {
        allCorrect = false;
      }
    }
    
    const percentCorrect = (correctCount / quizState.blankedWords.length) * 100;
    isCorrect = percentCorrect >= 80; // Still need 80% correct
    
    partialCredit = {
      correctCount,
      totalBlanks: quizState.blankedWords.length,
      percentCorrect,
      detailedResults // Include for better feedback
    };
    
  } else if (quizState.type === 'reference-recall') {
    const result = checkAnswerMatch(userAnswerToUse, quizState.answer);
    isCorrect = result.isCorrect;
    
  } else {
    // Multiple choice - exact match required
    isCorrect = userAnswerToUse === quizState.correctAnswer;
  }

  // ... rest of your submitQuiz function stays the same ...
  const pointsEarned = isCorrect ? QUIZ_POINTS[quizState.type] : 0;
  
  const newQuizzesCompleted = userData.quizzesCompleted + 1;
  const newTotalPoints = userData.totalPoints + pointsEarned;

  const verseId = quizState.verse.reference;
  const verseDifficulty = quizState.verse.difficulty || userData.selectedDifficulty;
  
  const currentProgress = userData.verseProgress[verseId] || {
    correctCount: 0,
    incorrectCount: 0,
    lastReview: null,
    nextReview: null,
    quizTypes: {},
  };

  if (!currentProgress.quizTypes[quizState.type]) {
    currentProgress.quizTypes[quizState.type] = { correct: 0, incorrect: 0 };
  }

  if (isCorrect) {
    currentProgress.correctCount++;
    currentProgress.quizTypes[quizState.type].correct++;
  } else {
    currentProgress.incorrectCount++;
    currentProgress.quizTypes[quizState.type].incorrect++;
  }

  currentProgress.lastReview = Date.now();
  currentProgress.nextReview = calculateNextReview(
    currentProgress.correctCount,
    currentProgress.incorrectCount
  );

  const newVerseProgress = {
    ...userData.verseProgress,
    [verseId]: currentProgress,
  };
  // Mastery helpers
  const requiredTypes = ["fill-blank", "multiple-choice", "reference-recall"];
  const isMasteredProgress = (progress) => requiredTypes.every(t => {
    const stats = (progress.quizTypes && progress.quizTypes[t]) || { correct: 0, incorrect: 0 };
    return stats.correct >= 3 && stats.incorrect === 0;
  });

  // ‚úÖ FIXED: Only count verses that are MASTERED (3+ correct answers with 0 incorrect)
  const masteredVerses = Object.entries(newVerseProgress).filter(([_, progress]) => 
    progress.correctCount >= 3 && progress.incorrectCount === 0
  );
  const newVersesMemorized = masteredVerses.length;

  // Work with Arrays instead of Sets
  const newMasteredByDifficulty = { ...userData.masteredVersesByDifficulty };
  Object.keys(newMasteredByDifficulty).forEach(key => {
    // Ensure we're working with arrays
    if (!Array.isArray(newMasteredByDifficulty[key])) {
      newMasteredByDifficulty[key] = Array.from(newMasteredByDifficulty[key] || []);
    } else {
      newMasteredByDifficulty[key] = [...newMasteredByDifficulty[key]];
    }
  });

  let isVerseNowMastered = false;
  if (isMasteredProgress(currentProgress)) {
    if (!newMasteredByDifficulty[verseDifficulty].includes(verseId)) {
      newMasteredByDifficulty[verseDifficulty].push(verseId);
      isVerseNowMastered = true;
    }
  }

  const newDifficultyProgress = { ...userData.difficultyProgress };
  newDifficultyProgress[verseDifficulty] = {
    ...newDifficultyProgress[verseDifficulty],
    mastered: newMasteredByDifficulty[verseDifficulty].length
  };

  const newAchievements = [...userData.achievements];

  if (newQuizzesCompleted >= 1 && !newAchievements.includes('a1')) {
    newAchievements.push('a1');
  }

  if (newVersesMemorized >= 10 && !newAchievements.includes('a3')) {
    newAchievements.push('a3');
  }

  if (newQuizzesCompleted >= 100 && !newAchievements.includes('k2')) {
    newAchievements.push('k2');
  }

  if (isCorrect && partialCredit?.percentCorrect === 100 && !newAchievements.includes('s3')) {
    newAchievements.push('s3');
  }

  const updatedUserData = {
    ...userData,
    quizzesCompleted: newQuizzesCompleted,
    totalPoints: newTotalPoints,
    achievements: newAchievements,
    verseProgress: newVerseProgress,
    versesMemorized: newVersesMemorized,
    difficultyProgress: newDifficultyProgress,
    masteredVersesByDifficulty: newMasteredByDifficulty,
    currentStreak: userData.currentStreak || 1,  // ‚úÖ FIXED: Include current streak so it doesn't default to 0
    lastActiveDate: userData.lastActiveDate  // ‚úÖ FIXED: Include lastActiveDate from Firebase
  };

  const { newDifficultyProgress: unlockedDifficultyProgress, hasUnlocked } = checkDifficultyUnlocks(updatedUserData);
  
  if (hasUnlocked) {
    updatedUserData.difficultyProgress = unlockedDifficultyProgress;
  }

  // ‚úÖ Save quiz WITHOUT recalculating streak
  if (currentUser) {
    try {
      await addQuizResult(currentUser.uid, {
        verseId: quizState.verse.id,
        verseReference: verseId,
        verseDifficulty: verseDifficulty,
        type: quizState.type,
        correct: isCorrect,
        timestamp: new Date(),
        points: pointsEarned,
        quizzesCompleted: newQuizzesCompleted,
        totalPoints: newTotalPoints,
        achievements: newAchievements,
        verseProgress: newVerseProgress,
        difficultyProgress: updatedUserData.difficultyProgress,
        // ‚úÖ Keep current streak - don't recalculate!
        currentStreak: updatedUserData.currentStreak,
        lastActiveDate: updatedUserData.lastActiveDate,
      });
      
      // ‚úÖ NEW: Increment today's quiz count
      setTodaysQuizzesCount(prev => prev + 1);
    } catch (err) {
      console.error('Error saving quiz result:', err);
    }
  }

  // ‚úÖ Update local state (streak unchanged from Firebase)
  setUserData(updatedUserData);

  // ============================================
  // üéâ ENHANCED FEEDBACK MESSAGES
  // ============================================
  if (isCorrect) {
    const progress = currentProgress.quizTypes[quizState.type];
    let message = `‚úÖ Correct! +${pointsEarned} points`;
    
    if (quizState.type === 'fill-blank' && partialCredit) {
      if (partialCredit.percentCorrect === 100) {
        message = `‚úÖ Perfect! All ${partialCredit.totalBlanks} blanks correct! +${pointsEarned} points`;
      } else {
        // Show which ones were accepted even with minor differences
        const acceptedWithVariations = partialCredit.detailedResults.filter(
          r => r.isCorrect && r.similarity < 1.0
        );
        
        if (acceptedWithVariations.length > 0) {
          message = `‚úÖ Great job! ${partialCredit.correctCount}/${partialCredit.totalBlanks} blanks correct! +${pointsEarned} points\n` +
                   `üí° We accepted minor spelling variations.`;
        } else {
          message = `‚úÖ Good job! ${partialCredit.correctCount}/${partialCredit.totalBlanks} blanks correct! +${pointsEarned} points`;
        }
      }
    } else if (isVerseNowMastered) {
      message += `\nüéØ Mastered this verse! You won't see it again for a while.`;
    }
    
    if (hasUnlocked) {
      message += `\n\nüéâ Congratulations! You've unlocked ${hasUnlocked} difficulty!`;
    }
    
  } else {
    let message = '';
    
    if (quizState.type === 'fill-blank') {
      // Show more helpful feedback
      const almostCorrect = partialCredit?.detailedResults?.filter(
        r => !r.isCorrect && r.similarity >= 0.7
      );
      
      const correctAnswers = quizState.blankedWords.map(item => item.word).join(', ');
      message = `Not quite. You got ${partialCredit?.correctCount || 0}/${quizState.blankedWords.length} correct.\n` +
        `The answers were: ${correctAnswers}\n`;
      
      if (almostCorrect && almostCorrect.length > 0) {
        message += `You were very close on some words! Keep practicing.\n`;
      }
      
      message += `You'll review this verse again soon.`;

      // Open styled correction prompt with Enhanced Review option
      setCorrectionPrompt({
        title: 'Not quite right',
        message,
        verseText: quizState.verse?.text || '',
        reference: quizState.verse?.reference || ''
      });
      return;
    } else if (quizState.type === 'reference-recall') {
      message = `Incorrect. The answer was: ${quizState.answer || ''}\nYou'll review this verse again soon.`;
      setCorrectionPrompt({
        title: 'Reference Recall ‚Äî Review',
        message,
        verseText: quizState.verse?.text || '',
        reference: quizState.verse?.reference || '',
        mode: 'reference'
      });
      return;
    } else {
      message = `Incorrect. The answer was: ${quizState.answer || quizState.correctAnswer}\n` +
        `You'll review this verse again soon.`;
    }
    
      alert(message);
    }
  }

  setCurrentView("home");
  setQuizState(null);
};

const AchievementsView = ({ userData, lastSeenAchievementsCount, setHasUnseenAchievements }) => {

  useEffect(() => {
    if (userData && userData.achievements.length > lastSeenAchievementsCount) {
      setHasUnseenAchievements(true);
    }
  }, [userData, lastSeenAchievementsCount, setHasUnseenAchievements]);

  return (
    <div className="space-y-6">
      <div className="text-center">
        <Award className="mx-auto text-amber-400 mb-2" size={48} />
        <h2 className="text-2xl font-bold text-amber-400">Achievements</h2>
        <p className="text-slate-300">Track your milestones</p>
      </div>

      <div className="bg-gradient-to-br from-amber-500/10 to-amber-600/10 border-2 border-amber-500/30 rounded-2xl p-6">
        <div className="text-center mb-4">
          <div className="text-4xl mb-2">üèÜ</div>
          <div className="text-3xl font-bold text-amber-400">{userData.achievements.length}</div>
          <div className="text-sm text-slate-300">Achievements Unlocked</div>
        </div>
      </div>

      {Object.entries(ACHIEVEMENTS).map(([tier, achievements]) => (
        <div key={tier} className="space-y-3">
          <h3 className="text-xl font-bold text-amber-400 capitalize">{tier}</h3>
          <div className="grid gap-3">
            {achievements.map((achievement) => {
              const isUnlocked = userData.achievements.includes(achievement.id);
              return (
                <div
                  key={achievement.id}
                  className={`p-4 rounded-xl border transition-all ${
                    isUnlocked
                      ? 'bg-amber-500/10 border-amber-500 shadow-lg shadow-amber-500/20'
                      : 'bg-slate-700/50 border-slate-600 opacity-60'
                  }`}
                >
                  <div className="flex items-center gap-3">
                    <div className="text-3xl">{achievement.icon}</div>
                    <div className="flex-1">
                      <div className="font-bold text-white">{achievement.name}</div>
                      <div className="text-sm text-slate-300">{achievement.desc}</div>
                    </div>
                    {isUnlocked && <div className="text-green-400 text-2xl">‚úì</div>}
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      ))}
    </div>
  );
};

  const QuizView = () => {
    const [userAnswer, setUserAnswer] = useState('');
    const [userAnswers, setUserAnswers] = useState([]);

    useEffect(() => {
      if (quizState) {
        if (quizState.type === 'fill-blank' && quizState.blankedWords) {
          setUserAnswers(new Array(quizState.blankedWords.length).fill(''));
        } else {
          setUserAnswer(quizState.userAnswer || '');
        }
      }
    }, [quizState]);

    if (!quizState) return null;

    const handleAnswerChange = (newAnswer, index = null) => {
      if (quizState.type === 'fill-blank' && index !== null) {
        const newAnswers = [...userAnswers];
        newAnswers[index] = newAnswer;
        setUserAnswers(newAnswers);
      } else {
        setUserAnswer(newAnswer);
      }
    };

    const handleSubmit = () => {
      if (quizState.type === 'fill-blank') {
        submitQuiz(userAnswers);
      } else {
        submitQuiz(userAnswer);
      }
    };

    const isSubmitDisabled = () => {
      if (quizState.type === 'fill-blank') {
        return !userAnswers.some(answer => answer.trim().length > 0);
      }
      return !userAnswer;
    };

    const potentialPoints = QUIZ_POINTS[quizState.type];

    return (
      <div className="space-y-6">
        <div className="bg-gradient-to-br from-slate-700 to-slate-800 rounded-2xl p-6 border border-amber-500/30">
          <div className="flex justify-between items-start mb-4">
            <div className="text-amber-400 font-bold">
              {quizState.type === 'fill-blank' && `Fill in the Blanks (${quizState.blankedWords?.length || 0} words)`}
              {quizState.type === 'multiple-choice' && 'Multiple Choice'}
              {quizState.type === 'reference-recall' && 'Reference Recall'}
            </div>
            <div className="bg-amber-500/20 border border-amber-500 px-3 py-1 rounded-full">
              <span className="text-amber-400 font-bold text-sm">+{potentialPoints} pts</span>
            </div>
          </div>

          <div className="text-white text-lg mb-6 leading-relaxed">
            {quizState.question}
          </div>

          {quizState.type === 'fill-blank' && (
            <div className="space-y-3">
              <div className="text-sm text-slate-400 mb-3">
                Fill in the missing words in order:
              </div>
              {quizState.blankedWords?.map((blank, index) => (
                <div key={index} className="flex items-center gap-3">
                  <span className="text-amber-400 font-bold min-w-[30px]">
                    [{index + 1}]
                  </span>
                  <input
                    type="text"
                    value={userAnswers[index] || ''}
                    onChange={(e) => handleAnswerChange(e.target.value, index)}
                    placeholder={`Word ${index + 1}...`}
                    className="flex-1 px-4 py-3 rounded-lg bg-slate-800 text-white border border-slate-600 focus:border-amber-500 focus:outline-none"
                    autoFocus={index === 0}
                  />
                </div>
              ))}
              <div className="text-xs text-slate-400 mt-2">
                üí° Tip: You need at least 80% correct to pass and earn {potentialPoints} points!
              </div>
            </div>
          )}

          {quizState.type === 'reference-recall' && (
            <input
              type="text"
              value={userAnswer}
              onChange={(e) => handleAnswerChange(e.target.value)}
              placeholder="Type the reference (e.g., John 3:16)..."
              className="w-full px-4 py-3 rounded-lg bg-slate-800 text-white border border-slate-600 focus:border-amber-500 focus:outline-none"
              autoFocus
            />
          )}

          {quizState.type === 'multiple-choice' && (
            <div className="space-y-3">
              {quizState.options.map((option, idx) => (
                <button
                  key={idx}
                  onClick={() => handleAnswerChange(option)}
                  className={`w-full p-4 rounded-lg border-2 transition-all text-left ${
                    userAnswer === option
                      ? 'bg-amber-500 border-amber-400 text-slate-900 font-bold'
                      : 'bg-slate-700 border-slate-600 text-white hover:border-amber-500'
                  }`}
                >
                  {option}
                </button>
              ))}
            </div>
          )}
        </div>

        <button
          onClick={handleSubmit}
          disabled={isSubmitDisabled()}
          className="w-full bg-gradient-to-r from-amber-500 to-amber-600 text-slate-900 font-bold py-4 rounded-xl hover:from-amber-600 hover:to-amber-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Submit Answer
        </button>

        <button
          onClick={() => {
            setCurrentView('home');
            setQuizState(null);
          }}
          className="w-full bg-slate-600 text-white font-bold py-3 rounded-xl hover:bg-slate-500 transition-all"
        >
          Cancel
        </button>
      </div>
    );
  };

  const ResultView = () => {
        todaysQuizzesCount={todaysQuizzesCount}
        userId={currentUser?.uid}
        onOpenAnalytics={() => setShowAnalyticsModal(true)}
        reloadCounter={sharpReload}
      />

      {/* Current Difficulty Display */}
      <div className={`bg-gradient-to-r ${ (getAllDifficultyConfig()[userData.selectedDifficulty]?.color) || 'from-amber-500 to-amber-600'} p-3 rounded-xl text-center`}>
        <div className="text-white font-bold text-lg">
          Current Difficulty: { (getAllDifficultyConfig()[userData.selectedDifficulty]?.displayName) || userData.selectedDifficulty}
        </div>
        <div className="text-white/80 text-sm">
          {userData.difficultyProgress[userData.selectedDifficulty].mastered}/{userData.difficultyProgress[userData.selectedDifficulty].total} verses mastered
        </div>
      </div>

      {/* Daily Motivation / Verse of the Day */}
      {verseOfDay && (
        <div className="bg-gradient-to-br from-amber-500/10 to-amber-600/10 border-2 border-amber-500/30 rounded-2xl p-6 relative">
          <div className="flex items-center justify-between mb-3">
            <div className="flex items-center gap-2">
              <Calendar className="text-amber-400" size={24} />
              <h2 className="text-xl font-bold text-amber-400">Daily Motivation</h2>
            </div>
            <div className="flex items-center gap-3">
              <div className="text-xs text-amber-400/70">
                Day {((Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24))) % 100) + 1} of 100
              </div>
              {/* ‚úÖ NEW: Read Checkbox */}
              <button
                onClick={handleDevotionalRead}
                className={`flex items-center gap-2 px-3 py-1 rounded-lg transition ${
                  devotionalRead
                    ? 'bg-green-500/30 border border-green-500 text-green-400'
                    : 'bg-amber-500/20 border border-amber-500/50 text-amber-300 hover:bg-amber-500/30'
                }`}
              >
                <input
                  type="checkbox"
                  checked={devotionalRead}
                  onChange={handleDevotionalRead}
                  className="w-4 h-4 cursor-pointer"
                />
                <span className="text-xs font-semibold">{devotionalRead ? 'Read ‚úì' : 'Mark Read'}</span>
              </button>
            </div>
          </div>
          <p className="text-white text-lg mb-3 leading-relaxed italic">"{verseOfDay.text}"</p>
          <p className="text-amber-300 font-semibold">‚Äî {verseOfDay.reference}</p>
        </div>
      )}

      {/* Quick Stats Grid */}
      <div className="grid grid-cols-2 gap-4">
        <div className="bg-slate-700/50 rounded-xl p-4 border border-slate-600">
          <div className="text-amber-400 text-3xl font-bold">{Object.values(userData.difficultyProgress).reduce((sum, diff) => sum + diff.mastered, 0)}</div>
          <div className="text-slate-300 text-sm">Verses Mastered</div>
          <div className="text-slate-400 text-xs mt-1">3+ correct, 0 wrong</div>
        </div>
        <div className="bg-slate-700/50 rounded-xl p-4 border border-slate-600">
          <div className="flex items-center justify-center gap-2">
            <div className="streak-container">
              <div className={`streak-flame ${getFlameTier(userData.currentStreak)}`}>
                <div className="flame-outer"></div>
                <div className="flame-inner"></div>
                <div className="flame-core"></div>
              </div>
              <span className="streak-count text-3xl font-bold">{userData.currentStreak}</span>
            </div>
          </div>
          <div className="text-slate-300 text-sm text-center">Day Streak</div>
        </div>
        <button
          onClick={() => setShowAnalyticsModal(true)}
          className="bg-slate-700/50 hover:bg-slate-600/50 rounded-xl p-4 border border-slate-600 hover:border-amber-400 transition-all cursor-pointer group w-full text-left"
        >
          <div className="text-amber-400 text-3xl font-bold group-hover:scale-105 transition-transform">{userData.quizzesCompleted}</div>
          <div className="text-slate-300 text-sm">Quizzes Completed</div>
          <div className="text-amber-300/70 text-xs mt-1 opacity-0 group-hover:opacity-100 transition-opacity">Click for analytics üìä</div>
        </button>
        <div className="bg-slate-700/50 rounded-xl p-4 border border-slate-600">
          <div className="text-amber-400 text-3xl font-bold">{userData.totalPoints}</div>
          <div className="text-slate-300 text-sm">Total Points</div>
        </div>
      </div>

      {/* Start Training Section */}
      <div>
        <h3 className="text-xl font-bold text-amber-400 mb-4">Start Training</h3>
        <div className="space-y-3">
          {/* Fill in the Blanks */}
          <button
            onClick={() => { markNewSeen('enhancedReview'); startQuiz('fill-blank'); }}
            disabled={loading}
            className="w-full bg-slate-700 hover:bg-slate-600 text-white p-4 rounded-xl border border-slate-600 hover:border-amber-500 transition-all text-left disabled:opacity-50 relative group"
          >
            <div className="absolute right-4 top-4 bg-amber-500 text-slate-900 px-3 py-1 rounded-full text-sm font-bold group-hover:bg-amber-400 transition-colors">
              +{QUIZ_POINTS['fill-blank']} pts
            </div>
            <div className="font-bold text-lg pr-20">{loading ? '‚è≥ Loading...' : 'Fill in the Blanks'}</div>
            <div className="text-slate-300 text-sm">Complete verses with 3-5 missing words</div>
            <div className="text-amber-400 text-xs mt-1">‚≠ê Highest difficulty - Most points!</div>
          </button>
          
          {/* Reference Recall */} 
          <button
            onClick={() => { markNewSeen('enhancedReview'); startQuiz('reference-recall'); }}
            disabled={loading}
            className="w-full bg-slate-700 hover:bg-slate-600 text-white p-4 rounded-xl border border-slate-600 hover:border-amber-500 transition-all text-left disabled:opacity-50 relative group"
          >
            <div className="absolute right-4 top-4 bg-blue-500 text-white px-3 py-1 rounded-full text-sm font-bold group-hover:bg-blue-400 transition-colors">
              +{QUIZ_POINTS['reference-recall']} pts
            </div>
            <div className="font-bold text-lg pr-20">{loading ? '‚è≥ Loading...' : 'Reference Recall'}</div>
            <div className="text-slate-400 text-sm">Name the verse reference</div>
            <div className="text-blue-400 text-xs mt-1">‚ö° Medium difficulty</div>
          </button>
          
          {/* Multiple Choice */}
          <button
            onClick={() => startQuiz('multiple-choice')}
            disabled={loading}
            className="w-full bg-slate-700 hover:bg-slate-600 text-white p-4 rounded-xl border border-slate-600 hover:border-amber-500 transition-all text-left disabled:opacity-50 relative group"
          >
            <div className="absolute right-4 top-4 bg-green-500 text-white px-3 py-1 rounded-full text-sm font-bold group-hover:bg-green-400 transition-colors">
              +{QUIZ_POINTS['multiple-choice']} pts
            </div>
            <div className="font-bold text-lg pr-20">{loading ? '‚è≥ Loading...' : 'Multiple Choice'}</div>
            <div className="text-slate-400 text-sm">Identify the correct reference</div>
            <div className="text-green-400 text-xs mt-1">‚úì Good for beginners</div>
          </button>
        </div>
      </div>
    </div>
  );
};

  const QuizView = () => {
    const [userAnswer, setUserAnswer] = useState('');
    const [userAnswers, setUserAnswers] = useState([]);

    useEffect(() => {
      if (quizState) {
        if (quizState.type === 'fill-blank' && quizState.blankedWords) {
          setUserAnswers(new Array(quizState.blankedWords.length).fill(''));
        } else {
          setUserAnswer(quizState.userAnswer || '');
        }
      }
    }, [quizState]);

    if (!quizState) return null;

    const handleAnswerChange = (newAnswer, index = null) => {
      if (quizState.type === 'fill-blank' && index !== null) {
        const newAnswers = [...userAnswers];
        newAnswers[index] = newAnswer;
        setUserAnswers(newAnswers);
      } else {
        setUserAnswer(newAnswer);
      }
    };

    const handleSubmit = () => {
      if (quizState.type === 'fill-blank') {
        submitQuiz(userAnswers);
      } else {
        submitQuiz(userAnswer);
      }
    };

    const isSubmitDisabled = () => {
      if (quizState.type === 'fill-blank') {
        return !userAnswers.some(answer => answer.trim().length > 0);
      }
      return !userAnswer;
    };

    const potentialPoints = QUIZ_POINTS[quizState.type];

    return (
      <div className="space-y-6">
        <div className="bg-gradient-to-br from-slate-700 to-slate-800 rounded-2xl p-6 border border-amber-500/30">
          <div className="flex justify-between items-start mb-4">
            <div className="text-amber-400 font-bold">
              {quizState.type === 'fill-blank' && `Fill in the Blanks (${quizState.blankedWords?.length || 0} words)`}
              {quizState.type === 'multiple-choice' && 'Multiple Choice'}
              {quizState.type === 'reference-recall' && 'Reference Recall'}
            </div>
            <div className="bg-amber-500/20 border border-amber-500 px-3 py-1 rounded-full">
              <span className="text-amber-400 font-bold text-sm">+{potentialPoints} pts</span>
            </div>
          </div>
          
          <div className="text-white text-lg mb-6 leading-relaxed">
            {quizState.question}
          </div>

          {quizState.type === 'fill-blank' && (
            <div className="space-y-3">
              <div className="text-sm text-slate-400 mb-3">
                Fill in the missing words in order:
              </div>
              {quizState.blankedWords?.map((blank, index) => (
                <div key={index} className="flex items-center gap-3">
                  <span className="text-amber-400 font-bold min-w-[30px]">
                    [{index + 1}]
                  </span>
                  <input
                    type="text"
                    value={userAnswers[index] || ''}
                    onChange={(e) => handleAnswerChange(e.target.value, index)}
                    placeholder={`Word ${index + 1}...`}
                    className="flex-1 px-4 py-3 rounded-lg bg-slate-800 text-white border border-slate-600 focus:border-amber-500 focus:outline-none"
                    autoFocus={index === 0}
                  />
                </div>
              ))}
              <div className="text-xs text-slate-400 mt-2">
                üí° Tip: You need at least 80% correct to pass and earn {potentialPoints} points!
              </div>
            </div>
          )}

          {quizState.type === 'reference-recall' && (
            <input
              type="text"
              value={userAnswer}
              onChange={(e) => handleAnswerChange(e.target.value)}
              placeholder="Type the reference (e.g., John 3:16)..."
              className="w-full px-4 py-3 rounded-lg bg-slate-800 text-white border border-slate-600 focus:border-amber-500 focus:outline-none"
              autoFocus
            />
          )}

          {quizState.type === 'multiple-choice' && (
            <div className="space-y-3">
              {quizState.options.map((option, idx) => (
                <button
                  key={idx}
                  onClick={() => handleAnswerChange(option)}
                  className={`w-full p-4 rounded-lg border-2 transition-all text-left ${
                    userAnswer === option
                      ? 'bg-amber-500 border-amber-400 text-slate-900 font-bold'
                      : 'bg-slate-700 border-slate-600 text-white hover:border-amber-500'
                  }`}
                >
                  {option}
                </button>
              ))}
            </div>
          )}
        </div>

        <button
          onClick={handleSubmit}
          disabled={isSubmitDisabled()}
          className="w-full bg-gradient-to-r from-amber-500 to-amber-600 text-slate-900 font-bold py-4 rounded-xl hover:from-amber-600 hover:to-amber-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Submit Answer
        </button>

        <button
          onClick={() => {
            setCurrentView('home');
            setQuizState(null);
          }}
          className="w-full bg-slate-600 text-white font-bold py-3 rounded-xl hover:bg-slate-500 transition-all"
        >
          Cancel
        </button>
      </div>
    );
  };

  const MasteryView = () => {
    const [selectedCategory, setSelectedCategory] = useState('difficulty');
    const [expandedGroups, setExpandedGroups] = useState({});

    const verseStats = Object.entries(userData.verseProgress).map(([reference, progress]) => {
      const totalAttempts = progress.correctCount + progress.incorrectCount;
      const accuracy = totalAttempts > 0 ? (progress.correctCount / totalAttempts) * 100 : 0;
      
      let masteryLevel = 'Learning';
      let masteryColor = 'text-slate-400';
      let bgColor = 'bg-slate-700/50';
      
      if (accuracy >= 90 && progress.correctCount >= 5) {
        masteryLevel = 'Mastered';
        masteryColor = 'text-green-400';
        bgColor = 'bg-green-500/10';
      } else if (accuracy >= 70 && progress.correctCount >= 3) {
        masteryLevel = 'Proficient';
        masteryColor = 'text-amber-400';
        bgColor = 'bg-amber-500/10';
      } else if (accuracy < 50 && totalAttempts >= 3) {
        masteryLevel = 'Struggling';
        masteryColor = 'text-red-400';
        bgColor = 'bg-red-500/10';
      }

      const verse = VERSE_DATABASE.find(v => v.reference === reference) || {};
      
      return {
        reference,
        accuracy: Math.round(accuracy),
        totalAttempts,
        correct: progress.correctCount,
        incorrect: progress.incorrectCount,
        masteryLevel,
        masteryColor,
        bgColor,
        lastReview: progress.lastReview,
        quizTypes: progress.quizTypes,
        difficulty: verse.difficulty || 'Beginner',
        topic: verse.topic || 'general',
        category: verse.category || 'canonical'
      };
    });

    const groupedVerses = {};
    verseStats.forEach(verse => {
      const key = verse[selectedCategory] || 'Unknown';
      if (!groupedVerses[key]) {
        groupedVerses[key] = [];
      }
      groupedVerses[key].push(verse);
    });

    const totalVerses = verseStats.length;
    const masteredCount = verseStats.filter(v => v.masteryLevel === 'Mastered').length;
    const proficientCount = verseStats.filter(v => v.masteryLevel === 'Proficient').length;
    const learningCount = verseStats.filter(v => v.masteryLevel === 'Learning').length;
    const strugglingCount = verseStats.filter(v => v.masteryLevel === 'Struggling').length;
    const overallAccuracy = totalVerses > 0 
      ? Math.round(verseStats.reduce((sum, v) => sum + v.accuracy, 0) / totalVerses)
      : 0;

    const toggleGroup = (groupName) => {
      setExpandedGroups(prev => ({
        ...prev,
        [groupName]: !prev[groupName]
      }));
    };

    return (
      <div className="space-y-6">
        <div className="text-center">
          <BarChart className="mx-auto text-amber-400 mb-2" size={48} />
          <h2 className="text-2xl font-bold text-amber-400">Mastery List</h2>
          <p className="text-slate-300">Track your progress on each verse</p>
        </div>

        <div className="bg-gradient-to-br from-amber-500/10 to-amber-600/10 border-2 border-amber-500/30 rounded-2xl p-6">
          <h3 className="text-xl font-bold text-amber-400 mb-4">Overall Progress</h3>
          
          <div className="mb-4">
            <div className="flex justify-between text-sm mb-2">
              <span className="text-white font-bold">Overall Accuracy</span>
              <span className="text-amber-400 font-bold">{overallAccuracy}%</span>
            </div>
            <div className="w-full bg-slate-700 rounded-full h-4 overflow-hidden">
              <div 
                className="bg-gradient-to-r from-amber-500 to-amber-600 h-full transition-all duration-500"
                style={{ width: `${overallAccuracy}%` }}
              />
            </div>
          </div>

          <div className="grid grid-cols-2 gap-3">
            <div className="bg-green-500/10 border border-green-500/30 rounded-lg p-3">
              <div className="text-2xl font-bold text-green-400">{masteredCount}</div>
              <div className="text-xs text-green-300">Mastered</div>
            </div>
            <div className="bg-amber-500/10 border border-amber-500/30 rounded-lg p-3">
              <div className="text-2xl font-bold text-amber-400">{proficientCount}</div>
              <div className="text-xs text-amber-300">Proficient</div>
            </div>
            <div className="bg-slate-700/50 border border-slate-600 rounded-lg p-3">
              <div className="text-2xl font-bold text-slate-300">{learningCount}</div>
              <div className="text-xs text-slate-400">Learning</div>
            </div>
            <div className="bg-red-500/10 border border-red-500/30 rounded-lg p-3">
              <div className="text-2xl font-bold text-red-400">{strugglingCount}</div>
              <div className="text-xs text-red-300">Struggling</div>
            </div>
          </div>
        </div>

        <div className="bg-slate-700/50 rounded-xl p-2 border border-slate-600">
          <div className="grid grid-cols-3 gap-2">
            {Object.entries(CATEGORY_CONFIG).map(([key, config]) => (
              <button
                key={key}
                onClick={() => setSelectedCategory(key)}
                className={`flex items-center justify-center gap-2 p-3 rounded-lg transition-all ${
                  selectedCategory === key
                    ? 'bg-amber-500 text-slate-900 font-bold'
                    : 'bg-slate-600 text-white hover:bg-slate-500'
                }`}
              >
                <span>{config.icon}</span>
                <span className="text-sm hidden sm:inline">{config.name}</span>
              </button>
            ))}
          </div>
        </div>

        {totalVerses === 0 ? (
          <div className="bg-slate-700/50 rounded-xl p-8 border border-slate-600 text-center">
            <div className="text-4xl mb-3">üìñ</div>
            <p className="text-slate-300">Complete some quizzes to see your verse mastery progress!</p>
          </div>
        ) : (
          <div className="space-y-3">
            {Object.entries(groupedVerses)
              .sort((a, b) => {
                const categoryValues = CATEGORY_CONFIG[selectedCategory]?.values;
                if (categoryValues) {
                  const aIndex = Object.keys(categoryValues).indexOf(a[0]);
                  const bIndex = Object.keys(categoryValues).indexOf(b[0]);
                  if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
                }
                return a[0].localeCompare(b[0]);
              })
              .map(([groupName, verses]) => {
                const isExpanded = expandedGroups[groupName];
                const masteredInGroup = verses.filter(v => v.masteryLevel === 'Mastered').length;
                const totalInGroup = verses.length;
                const groupAccuracy = verses.length > 0
                  ? Math.round(verses.reduce((sum, v) => sum + v.accuracy, 0) / verses.length)
                  : 0;

                const categoryConfig = CATEGORY_CONFIG[selectedCategory]?.values[groupName] || {
                  icon: 'üìå',
                  color: 'from-slate-500 to-slate-600'
                };

                return (
                  <div key={groupName} className="bg-slate-700/50 rounded-xl border border-slate-600 overflow-hidden">
                    <button
                      onClick={() => toggleGroup(groupName)}
                      className="w-full p-4 flex items-center justify-between hover:bg-slate-700/70 transition-all"
                    >
                      <div className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-lg bg-gradient-to-r ${categoryConfig.color} flex items-center justify-center text-xl`}>
                          {categoryConfig.icon}
                        </div>
                        <div className="text-left">
                          <div className="font-bold text-white text-lg capitalize">{groupName}</div>
                          <div className="text-sm text-slate-400">
                            {masteredInGroup}/{totalInGroup} mastered ‚Ä¢ {groupAccuracy}% avg accuracy
                          </div>
                        </div>
                      </div>
                      <div className="flex items-center gap-3">
                        <div className="text-right hidden sm:block">
                          <div className="text-green-400 font-bold">{masteredInGroup}</div>
                          <div className="text-xs text-slate-400">Mastered</div>
                        </div>
                        {isExpanded ? (
                          <ChevronDown className="text-amber-400" size={24} />
                        ) : (
                          <ChevronRight className="text-amber-400" size={24} />
                        )}
                      </div>
                    </button>

                    {isExpanded && (
                      <div className="border-t border-slate-600 bg-slate-800/30 p-4 space-y-3">
                        {verses
                          .sort((a, b) => a.accuracy - b.accuracy)
                          .map((verse) => (
                            <div 
                              key={verse.reference}
                              className={`${verse.bgColor} border border-slate-600 rounded-xl p-4`}
                            >
                              <div className="flex items-start justify-between mb-3">
                                <div className="flex-1">
                                  <div className="font-bold text-white text-lg">{verse.reference}</div>
                                  <div className={`text-sm font-semibold ${verse.masteryColor}`}>
                                    {verse.masteryLevel}
                                  </div>
                                </div>
                                <div className="text-right">
                                  <div className={`text-2xl font-bold ${verse.masteryColor}`}>
                                    {verse.accuracy}%
                                  </div>
                                  <div className="text-xs text-slate-400">
                                    {verse.correct}‚úì / {verse.incorrect}‚úó
                                  </div>
                                </div>
                              </div>

                              <div className="w-full bg-slate-800 rounded-full h-3 overflow-hidden mb-3">
                                <div 
                                  className={`h-full transition-all duration-500 ${
                                    verse.masteryLevel === 'Mastered' ? 'bg-gradient-to-r from-green-500 to-green-600' :
                                    verse.masteryLevel === 'Proficient' ? 'bg-gradient-to-r from-amber-500 to-amber-600' :
                                    verse.masteryLevel === 'Struggling' ? 'bg-gradient-to-r from-red-500 to-red-600' :
                                    'bg-gradient-to-r from-slate-500 to-slate-600'
                                  }`}
                                  style={{ width: `${verse.accuracy}%` }}
                                />
                              </div>

                              <div className="grid grid-cols-3 gap-2 text-xs">
                                {Object.entries(verse.quizTypes).map(([type, stats]) => {
                                  const typeAccuracy = stats.correct + stats.incorrect > 0
                                    ? Math.round((stats.correct / (stats.correct + stats.incorrect)) * 100)
                                    : 0;
                                  return (
                                    <div key={type} className="bg-slate-800/50 rounded px-2 py-1">
                                      <div className="text-slate-400 truncate">
                                        {type === 'fill-blank' ? '‚úèÔ∏è Fill' : 
                                         type === 'multiple-choice' ? 'üìù Choice' : 
                                         'üîç Recall'}
                                      </div>
                                      <div className="text-white font-bold">{typeAccuracy}%</div>
                                    </div>
                                  );
                                })}
                              </div>
                            </div>
                          ))}
                      </div>
                    )}
                  </div>
                );
              })}
          </div>
        )}
      </div>
    );
  };

  const SettingsView = () => {
  const creedPlainText = `S.H.A.R.P. Creed of the Way\n\n1. The Way of the Father\nI walk in the Way of the One who made heaven and earth, whose breath gives life to every soul. I honor His commands, for His Word is truth and His mercy endures forever. He is not far from any of us, for in Him we live, and move, and have our being. (Psalm 119:160; Acts 17:27‚Äì28)\n\n2. The Way of the Son\nI follow Jesus the Anointed, the Word made flesh, who came not to be served but to serve, who healed the broken, forgave the sinner, and showed us the face of the Father. I take up my cross daily and walk after Him, for He is the Way, the Truth, and the Life. (John 1:14; Luke 9:23; John 14:6)\n\n3. The Way of the Spirit\nI receive the Holy Spirit, promised from above, who writes the law of God upon the heart and teaches me to walk in His statutes and judgments. The Spirit gives light to the humble and power to the obedient. (Ezekiel 36:27; John 14:26; Acts 2:38)\n\n4. The Way of the Word\nI meditate on the Scriptures day and night. They are the lamp for my path and the voice that corrects my steps. I do not twist them for my own gain, but seek understanding through prayer, humility, and love. (Psalm 1:2; Psalm 119:105; 2 Peter 3:16)\n\n5. The Way of the Body\nI walk with the brethren in unity and peace, bearing one another‚Äôs burdens, sharing bread with the poor, and rejoicing with those who rejoice. In love we serve, in patience we forgive, for we are one Body and one Spirit in the Lord. (Acts 2:42‚Äì47; Ephesians 4:3‚Äì4; Galatians 6:2)\n\n6. The Way of Truth and Grace\nI speak truth without hatred, and correction without pride. I test every spirit by the Word of God, and hold fast what is good. Grace is my covering, mercy my weapon, humility my crown. (Ephesians 4:15; 1 John 4:1; 1 Thessalonians 5:21)\n\n7. The Way of the Kingdom\nI seek first the Kingdom of God and His righteousness. I store no treasure for myself that moth and rust destroy, but labor for the reward that does not fade. Until the Lord returns, I watch, pray, and remain steadfast. (Matthew 6:33; Matthew 6:19‚Äì21; Luke 12:35‚Äì37)\n\n8. The Way of Love\nAbove all, I love the Lord my God with all my heart, soul, mind, and strength ‚Äî and I love my neighbor as myself. For love is the bond of perfection, and whoever abides in love abides in God. (Matthew 22:37‚Äì39; Colossians 3:14; 1 John 4:16)\n\nClosing Confession\nThis is the Way: to believe in the Son, to walk by the Spirit, to serve the Father in holiness and truth. To know Him is life everlasting. (John 17:3)`;

  const handleCopyCreed = async () => {
    try {
      await navigator.clipboard.writeText(creedPlainText);
      alert('Creed copied to clipboard.');
    } catch (e) {
      alert('Copy failed.');
    }
  };

  const handleDownloadCreed = () => {
    const html = `<!doctype html><html><head><meta charset="utf-8"/><title>S.H.A.R.P. Creed of the Way</title><style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;line-height:1.6;color:#0f172a;padding:32px;max-width:800px;margin:0 auto}h1{font-size:24px;margin:0 0 16px;color:#92400e}h2{font-size:16px;margin:16px 0 8px;color:#1f2937}p{margin:8px 0}</style></head><body><h1>S.H.A.R.P. Creed of the Way</h1>${creedPlainText.split('\n\n').map(block=>`<p>${block.replace(/\n/g,'<br/>')}</p>`).join('')}<script>window.onload=()=>{window.print();}</script></body></html>`;
    const w = window.open('', '_blank');
    if (!w) return;
    w.document.open();
    w.document.write(html);
    w.document.close();
    w.focus();
  };

  return (
  <div className="space-y-6">
    <h2 className="text-2xl font-bold text-amber-400">Settings</h2>
    <div className="mt-4 grid gap-4">
      <div className="bg-slate-700/50 rounded-xl p-4 border border-slate-600">
        <h3 className="text-white font-bold mb-2">S.H.A.R.P. Conversation History</h3>
        <p className="text-slate-400 text-sm mb-3">Review or resume past assistant sessions saved on this device.</p>
        <button onClick={openSharpHistory} className="px-3 py-2 rounded bg-white/15 hover:bg-white/25 text-white border border-white/20">
          Open History
        </button>
      </div>
    </div>
    
    <div className="bg-slate-700/50 rounded-xl p-4 border border-slate-600">
      <label className="block text-white font-bold mb-3">Difficulty Level</label>
      
      <div className="space-y-3">
        {Object.entries(getAllDifficultyConfig()).map(([key, config]) => {
          const progress = userData.difficultyProgress[key];
          const isLocked = progress.locked;
          const isCurrent = userData.selectedDifficulty === key;
          const masteryPercent = (progress.mastered / progress.total) * 100;
          
          return (
            <div
              key={key}
              className={`relative rounded-lg border-2 overflow-hidden transition-all ${
                isLocked 
                  ? 'border-slate-600 opacity-50' 
                  : isCurrent 
                    ? 'border-amber-500 shadow-lg shadow-amber-500/20' 
                    : 'border-slate-500 hover:border-amber-400'
              }`}
            >
              <div 
                className={`absolute inset-0 bg-gradient-to-r ${config.color} opacity-10`}
              />
              
              <button
                onClick={() => {
                  if (isLocked) return;
                  setUserData(prev => {
                    const nextData = { ...prev };
                    // Ensure progress buckets exist for newly introduced Apocrypha difficulties
                    if (!nextData.difficultyProgress[key]) {
                      nextData.difficultyProgress[key] = { mastered: 0, total: (config.total || (config.verses ? config.verses.length : 0) || 0), locked: false };
                    }
                    if (!nextData.masteredVersesByDifficulty[key]) {
                      nextData.masteredVersesByDifficulty[key] = [];
                    }
                    nextData.selectedDifficulty = key;
                    return nextData;
                  });
                }}
                disabled={isLocked}
                className="relative w-full p-4 text-left"
              >
                <div className="flex items-center justify-between mb-2">
                  <div className="flex items-center gap-2">
                    <span className="text-xl text-white">{config.displayName}</span>
                    {isLocked && <span className="text-slate-400">üîí</span>}
                    {isCurrent && <span className="text-amber-400">‚úì</span>}
                  </div>
                  <div className="text-sm text-slate-300">
                    {progress.mastered}/{progress.total} mastered
                  </div>
                </div>
                
                <p className="text-sm text-slate-400 mb-2">{config.description}</p>
                
                <div className="w-full bg-slate-800 rounded-full h-2 overflow-hidden">
                  <div 
                    className={`h-full transition-all duration-500 bg-gradient-to-r ${config.color}`}
                    style={{ width: `${masteryPercent}%` }}
                  />
                </div>
                
                {isLocked && (
                  <p className="text-xs text-amber-400 mt-2">
                    Unlock: Master {config.unlockCondition} verses from previous level
                  </p>
                )}
              </button>
            </div>
          );
        })}
      </div>
    </div>
    
    <div className="bg-slate-700/50 rounded-xl p-4 border border-slate-600">
      <label className="block text-white font-bold mb-3">Translation</label>
      <select
        value={userData.selectedTranslation}
        onChange={(e) => setUserData(prev => ({...prev, selectedTranslation: e.target.value}))}
        className="w-full px-4 py-3 rounded-lg bg-slate-800 text-white border border-slate-600 focus:border-amber-500 focus:outline-none"
      >
        <option value="KJV">King James Version (KJV)</option>
        <option value="NKJV">New King James Version (NKJV)</option>
        <option value="NIV">New International Version (NIV)</option>
        <option value="NLT">New Living Translation (NLT)</option>
        <option value="YLT">Young's Literal Translation (YLT)</option>
        <option value="WEB">World English Bible (WEB)</option>
        <option value="ASV">American Standard Version (ASV)</option>
        <option value="ESV">English Standard Version (ESV)</option>
        <option value="NASB">New American Standard Bible (NASB)</option>
      </select>
    </div>

    {/* S.H.A.R.P. Creed of the Way */}
    <div className="bg-slate-700/50 rounded-xl p-4 border border-slate-600">
      <h3 className="text-white font-bold mb-2">S.H.A.R.P. Creed of the Way</h3>
      <p className="text-slate-400 text-sm mb-3">
        This creed is presented in the spirit of the earliest followers of Jesus ‚Äî
        simple, reverent, and grounded in Scripture. It is aligned with the
        teachings of Christ and the apostles in the Holy Scriptures and is not a
        product of later traditions, denominational doctrines, or human systems.
      </p>
      <div className="flex flex-wrap gap-2 mb-3">
        <button onClick={handleCopyCreed} className="px-3 py-1 rounded bg-white/15 hover:bg-white/25 text-white text-sm border border-white/20">Copy Creed</button>
        <button onClick={handleDownloadCreed} className="px-3 py-1 rounded bg-amber-500/80 hover:bg-amber-500 text-slate-900 text-sm font-bold">Download PDF</button>
      </div>
      <details className="bg-slate-800/40 rounded-md border border-slate-600">
        <summary className="cursor-pointer px-3 py-2 text-amber-300 select-none">Read the Creed</summary>
        <div className="px-3 py-3 text-slate-200 space-y-3 text-sm">
          <div>
            <div className="font-semibold">1) The Way of the Father</div>
            <p>
              I walk in the Way of the One who made heaven and earth, whose breath gives life to every soul.
              I honor His commands, for His Word is truth and His mercy endures forever. He is not far from any of us,
              for in Him we live, and move, and have our being. <span className="text-slate-400">(Psalm 119:160; Acts 17:27‚Äì28)</span>
            </p>
          </div>
          <div>
            <div className="font-semibold">2) The Way of the Son</div>
            <p>
              I follow Jesus the Anointed, the Word made flesh, who came not to be served but to serve, who healed the broken,
              forgave the sinner, and showed us the face of the Father. I take up my cross daily and walk after Him, for He is the Way,
              the Truth, and the Life. <span className="text-slate-400">(John 1:14; Luke 9:23; John 14:6)</span>
            </p>
          </div>
          <div>
            <div className="font-semibold">3) The Way of the Spirit</div>
            <p>
              I receive the Holy Spirit, promised from above, who writes the law of God upon the heart and teaches me to walk
              in His statutes and judgments. The Spirit gives light to the humble and power to the obedient.
              <span className="text-slate-400"> (Ezekiel 36:27; John 14:26; Acts 2:38)</span>
            </p>
          </div>
          <div>
            <div className="font-semibold">4) The Way of the Word</div>
            <p>
              I meditate on the Scriptures day and night. They are the lamp for my path and the voice that corrects my steps.
              I do not twist them for my own gain, but seek understanding through prayer, humility, and love.
              <span className="text-slate-400"> (Psalm 1:2; Psalm 119:105; 2 Peter 3:16)</span>
            </p>
          </div>
          <div>
            <div className="font-semibold">5) The Way of the Body</div>
            <p>
              I walk with the brethren in unity and peace, bearing one another‚Äôs burdens, sharing bread with the poor, and rejoicing with those who rejoice.
              In love we serve, in patience we forgive, for we are one Body and one Spirit in the Lord.
              <span className="text-slate-400"> (Acts 2:42‚Äì47; Ephesians 4:3‚Äì4; Galatians 6:2)</span>
            </p>
          </div>
          <div>
            <div className="font-semibold">6) The Way of Truth and Grace</div>
            <p>
              I speak truth without hatred, and correction without pride. I test every spirit by the Word of God, and hold fast what is good.
              Grace is my covering, mercy my weapon, humility my crown. <span className="text-slate-400">(Ephesians 4:15; 1 John 4:1; 1 Thessalonians 5:21)</span>
            </p>
          </div>
          <div>
            <div className="font-semibold">7) The Way of the Kingdom</div>
            <p>
              I seek first the Kingdom of God and His righteousness. I store no treasure for myself that moth and rust destroy, but labor for the reward that does not fade.
              Until the Lord returns, I watch, pray, and remain steadfast. <span className="text-slate-400">(Matthew 6:33; Matthew 6:19‚Äì21; Luke 12:35‚Äì37)</span>
            </p>
          </div>
          <div>
            <div className="font-semibold">8) The Way of Love</div>
            <p>
              Above all, I love the Lord my God with all my heart, soul, mind, and strength ‚Äî and I love my neighbor as myself.
              For love is the bond of perfection, and whoever abides in love abides in God.
              <span className="text-slate-400"> (Matthew 22:37‚Äì39; Colossians 3:14; 1 John 4:16)</span>
            </p>
          </div>
          <div>
            <div className="font-semibold">Closing Confession</div>
            <p>
              This is the Way: to believe in the Son, to walk by the Spirit, to serve the Father in holiness and truth.
              To know Him is life everlasting. <span className="text-slate-400">(John 17:3)</span>
            </p>
          </div>
        </div>
      </details>
    </div>

    <div className="bg-slate-700/50 rounded-xl p-4 border border-slate-600">
      <label className="flex items-center justify-between">
        <span className="text-white font-bold">Include Apocrypha</span>
        <input
          type="checkbox"
          checked={userData.includeApocrypha}
          onChange={(e) => setUserData(prev => ({...prev, includeApocrypha: e.target.checked}))}
          className="w-6 h-6 rounded bg-slate-800 border-slate-600 text-amber-500 focus:ring-amber-500"
        />
      </label>
      <p className="text-slate-400 text-sm mt-2">
        Include verses from the Apocrypha in your training
      </p>
    </div>

    <div className="bg-slate-700/50 rounded-xl p-4 border border-slate-600">
      <div className="flex items-center justify-between mb-2">
        <div>
          <h3 className="text-white font-bold flex items-center gap-2">
            üìú Ancient Study
            {userData.difficultyProgress.Advanced.locked && <span className="text-amber-400">üîí</span>}
          </h3>
        </div>
        <div className={`px-3 py-1 rounded-full text-xs font-bold ${
          userData.difficultyProgress.Advanced.locked 
            ? 'bg-slate-600 text-slate-400' 
            : 'bg-green-500 text-white'
        }`}>
          {userData.difficultyProgress.Advanced.locked ? 'LOCKED' : 'UNLOCKED'}
        </div>
      </div>
      <p className="text-slate-400 text-sm mb-3">
        Access the complete Septuagint (LXX) and Codex Sinaiticus New Testament with transliterated Greek text.
      </p>
      {userData.difficultyProgress.Advanced.locked ? (
        <div className="bg-amber-500/10 border border-amber-500/30 rounded-lg p-3">
          <p className="text-amber-400 text-sm">
            üîì Unlock Requirement: Reach Advanced difficulty
          </p>
          <p className="text-amber-300 text-xs mt-1">
            Progress: Master {100 - userData.difficultyProgress.Intermediate.mastered} more Intermediate verses
          </p>
          <div className="w-full bg-slate-800 rounded-full h-2 overflow-hidden mt-2">
            <div 
              className="h-full transition-all duration-500 bg-gradient-to-r from-amber-500 to-amber-600"
              style={{ width: `${(userData.difficultyProgress.Intermediate.mastered / 100) * 100}%` }}
            />
          </div>
        </div>
      ) : (
        <button
          onClick={() => setCurrentView('ancient-study')}
          className="w-full bg-gradient-to-r from-amber-500 to-amber-600 text-slate-900 font-bold py-2 rounded-lg hover:from-amber-600 hover:to-amber-700 transition-all"
        >
          Open Ancient Study
        </button>
      )}
    </div>

    <div className="bg-slate-700/50 rounded-xl p-4 border border-slate-600">
      <h3 className="text-white font-bold mb-2">About</h3>
      <p className="text-slate-400 text-sm">Sword Drill v1.0</p>
      <p className="text-slate-400 text-sm">Gamified Bible Memorization</p>
      <p className="text-slate-400 text-sm mt-2">Firebase & GitHub integration ready</p>
    </div>

    <div className="bg-gradient-to-br from-amber-500/10 to-amber-600/10 border-2 border-amber-500/30 rounded-2xl p-6">
      <div className="text-center mb-4">
        <div className="text-4xl mb-3">üôèüèæ</div>
        <h3 className="text-2xl font-bold text-amber-400 mb-2">Support This Ministry</h3>
      </div>
      
      <div className="bg-slate-800/50 rounded-xl p-4 mb-4">
        <p className="text-slate-200 text-sm leading-relaxed mb-4">
          ‚ú® <span className="font-bold text-amber-400">Fuel the Fire of the Word</span>
        </p>
        <p className="text-slate-300 text-sm leading-relaxed mb-3">
          Every gift given to Sword Drill carries eternal impact. Your donation helps place Bibles into the hands of those seeking the light of God, bring aid to those in need, and keep this app alive for every soul hungry to know His Word.
        </p>
        <p className="text-slate-300 text-sm leading-relaxed mb-3">
          When you give, you're not just supporting an app ‚Äî you're helping to ignite faith, spread hope, and equip believers with the Sword of the Spirit across the world.
        </p>
        <p className="text-slate-300 text-sm leading-relaxed">
          Together, we stand as torchbearers for the Kingdom ‚Äî letting His Word cut through darkness and bring life to those who long for it. üôèüèæ‚öîÔ∏è
        </p>
      </div>

      <a
        href="https://www.paypal.com/paypalme/ychristdonations"
        target="_blank"
        rel="noopener noreferrer"
        className="block w-full bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-slate-900 font-bold py-4 px-6 rounded-xl transition-all transform hover:scale-105 text-center shadow-lg"
      >
        üíù Donate via PayPal
      </a>
      
      <p className="text-center text-slate-400 text-xs mt-3">
        ychristdonations@gmail.com
      </p>
    </div>
  </div>
);

  // ===== Enhanced Review (drag-and-drop) =====
  const beginEnhancedReview = (text, reference) => {
    if (!text) return;
    const tokens = text
      .split(/\s+/)
      .map(w => w.replace(/[^\w‚Äô'-]/g, ''))
      .filter(Boolean);
    const bank = tokens.map((t, i) => ({ id: `${i}-${Math.random().toString(36).slice(2,7)}`, text: t }));
    for (let i = bank.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [bank[i], bank[j]] = [bank[j], bank[i]];
    }
    setEnhancedReview({ reference: reference || '', expected: tokens, bank, slots: new Array(tokens.length).fill(null), used: new Set(), feedback: null });
    setCurrentView('enhanced-review');
  };

  // Regenerate a new Fill-in-the-Blank for the same verse
  const retryFillBlank = () => {
    try {
      if (!quizState || !quizState.verse || !quizState.verse.text) {
        setCurrentView('home');
        return;
      }
      const verse = quizState.verse;
      const words = (verse.text || '').split(' ');
      const numBlanks = Math.min(Math.max(3, Math.floor(words.length * 0.15)), 5);
      const blankedWords = [];
      const usedIndices = new Set();
      let safetyCounter = 0;
      while (blankedWords.length < numBlanks && safetyCounter < 100) {
        const randomIndex = Math.floor(Math.random() * words.length);
        const word = (words[randomIndex] || '').replace(/[.,;:!?'"]/g, '');
        if (!usedIndices.has(randomIndex) && word.length > 3) {
          usedIndices.add(randomIndex);
          blankedWords.push({ index: randomIndex, word });
        }
        safetyCounter++;
      }
      if (blankedWords.length < numBlanks) {
        safetyCounter = 0;
        while (blankedWords.length < numBlanks && safetyCounter < 100) {
          const randomIndex = Math.floor(Math.random() * words.length);
          const word = (words[randomIndex] || '').replace(/[.,;:!?'"]/g, '');
          if (!usedIndices.has(randomIndex) && word.length > 0) {
            usedIndices.add(randomIndex);
            blankedWords.push({ index: randomIndex, word });
          }
          safetyCounter++;
        }
      }
      blankedWords.sort((a, b) => a.index - b.index);
      const questionWords = [...words];
      blankedWords.forEach((blank, i) => {
        questionWords[blank.index] = `[${i + 1}]______`;
      });
      setQuizState({
        type: 'fill-blank',
        verse: { ...verse },
        question: questionWords.join(' '),
        blankedWords,
        userAnswers: new Array(blankedWords.length).fill(''),
      });
      setCurrentView('quiz');
    } catch (_) {
      setCurrentView('home');
    }
  };

  const retryReferenceRecall = () => {
    try {
      if (!quizState || !quizState.verse) { setCurrentView('home'); return; }
      const verse = quizState.verse;
      setQuizState({
        type: 'reference-recall',
        verse: { ...verse },
        question: verse.text,
        answer: verse.reference,
        userAnswer: ''
      });
      setCurrentView('quiz');
    } catch (_) {
      setCurrentView('home');
    }
  };

  
  // Begin Reference Recall Enhanced Review
  const beginReferenceReview = (verseText, correctReference) => {
    const correct = (correctReference || '').trim();
    // Build distractors from local verse DB
    const pool = VERSE_DATABASE.map(v => v.reference).filter(r => r && r !== correct);
    const distractors = [];
    const used = new Set([correct]);
    while (distractors.length < 5 && pool.length > 0) {
      const r = pool[Math.floor(Math.random() * pool.length)];
      if (!used.has(r)) { distractors.push(r); used.add(r); }
    }
    const bankList = [correct, ...distractors];
    const bank = bankList
      .map((t, i) => ({ id: `${i}-${Math.random().toString(36).slice(2,7)}`, text: t }))
      .sort(() => Math.random() - 0.5);

    setEnhancedReview({
      mode: 'reference',
      reference: correct,
      verseText: verseText || '',
      expected: [correct],
      bank,
      slots: [null],
      used: new Set(),
      feedback: null,
    });
    setCurrentView('enhanced-review');
  };const EnhancedReviewView = () => {
    const state = enhancedReview;
    if (!state) return null;

    const onDropWord = (slotIdx, itemId) => {
      const item = state.bank.find(b => b.id === itemId);
      if (!item) return;
      const newSlots = [...state.slots];
      const newUsed = new Set(state.used);
      if (newSlots[slotIdx]) newUsed.delete(newSlots[slotIdx]);
      newSlots[slotIdx] = item.id;
      newUsed.add(item.id);
      setEnhancedReview({ ...state, slots: newSlots, used: newUsed, feedback: null });
    };

    const removeFromSlot = (slotIdx) => {
      const newSlots = [...state.slots];
      const newUsed = new Set(state.used);
      if (newSlots[slotIdx]) newUsed.delete(newSlots[slotIdx]);
      newSlots[slotIdx] = null;
      setEnhancedReview({ ...state, slots: newSlots, used: newUsed, feedback: null });
    };

    const checkAnswer = () => {
      const chosen = state.slots.map(id => {
        const it = state.bank.find(b => b.id === id);
        return it ? it.text : '';
      });
      let allCorrect = true;
      const diffs = chosen.map((t, i) => {
        const ok = t && t.toLowerCase() === state.expected[i].toLowerCase();
        if (!ok) allCorrect = false;
        return ok;
      });
      const wasCorrect = state.feedback && state.feedback.allCorrect;
      setEnhancedReview({ ...state, feedback: { diffs, allCorrect } });
      if (allCorrect && !wasCorrect) {
        if (state.mode === "words") {
          try { setUserData(prev => ({ ...prev, totalPoints: (prev.totalPoints||0) + 50 })); } catch(_){}
        } else if (state.mode === "reference") {
          try { setUserData(prev => ({ ...prev, totalPoints: (prev.totalPoints||0) + 2 })); } catch(_){}
        }
      }
    };

    const resetAll = () => {
      setEnhancedReview({ ...state, slots: new Array(state.expected.length).fill(null), used: new Set(), feedback: null });
    };

    const finish = () => {
      setCurrentView('home');
      setEnhancedReview(null);
      setQuizState(null);
    };

    const draggableWord = (w) => (
      <div
        key={w.id}
        draggable={!state.used.has(w.id)}
        onDragStart={(e)=>{ e.dataTransfer.setData('text/plain', w.id); }}
        className={`px-2 py-1 rounded border text-sm select-none ${state.used.has(w.id) ? 'opacity-40 cursor-not-allowed bg-slate-700/40 border-slate-600 text-slate-400' : 'bg-slate-700 border-slate-500 text-white hover:bg-slate-600'}`}
        title={w.text}
      >{w.text}</div>
    );

    return (
      <div className="space-y-6">
        <div className="text-center space-y-2">
          <h2 className="text-2xl font-bold text-amber-400">
            {state.mode === 'reference' ? 'Reference Recall ‚Äî Enhanced Review' : 'Enhanced Review'}
          </h2>
          {state.mode === 'reference' ? (
            <>
              <p className="text-slate-300 text-sm">Drag the correct reference into the slot below.</p>
              <div className="text-left bg-slate-800/50 border border-slate-600 rounded p-3 text-white text-sm">
                {state.verseText}
              </div>
            </>
          ) : (
            <>
              <p className="text-slate-300 text-sm">Rebuild the verse by dragging words from the bank into the blanks.</p>
              {state.reference && <p className="text-slate-400 text-xs mt-1">{state.reference}</p>}
            </>
          )}
        </div>

        <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-600">
          <div className="flex flex-wrap gap-2">
            {state.expected.map((exp, idx) => {
              const placedId = state.slots[idx];
              const placed = state.bank.find(b => b.id === placedId);
              const borderCls = state.feedback ? (state.feedback.diffs[idx] ? 'border-green-500' : 'border-red-500') : 'border-slate-600';
              const slotTitle = state.mode === 'reference' ? (placed ? 'Click to remove' : 'Drop reference here') : (placed ? 'Click to remove' : 'Drop word here');
              return (
                <div
                  key={idx}
                  onDragOver={(e)=>e.preventDefault()}
                  onDrop={(e)=>{ e.preventDefault(); const id=e.dataTransfer.getData('text/plain'); onDropWord(idx, id); }}
                  onClick={()=> placed && removeFromSlot(idx)}
                  className={`min-w-[60px] px-2 py-1 rounded border ${borderCls} text-center bg-slate-900/40 text-white cursor-pointer`}
                  title={slotTitle}
                >
                  {placed ? placed.text : '_____'}
                </div>
              );
            })}
          </div>
        </div>

        <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-600">
          <div className="text-slate-300 text-sm mb-2">{state.mode === 'reference' ? 'Reference Bank' : 'Word Bank'}</div>
          <div className="flex flex-wrap gap-2">
            {state.bank.map(draggableWord)}
          </div>
        </div>

        <div className="flex flex-wrap gap-2">
          <button onClick={checkAnswer} className="px-3 py-2 rounded bg-amber-500 text-slate-900 font-bold">Check Answer</button>
          <button onClick={resetAll} className="px-3 py-2 rounded bg-slate-700 text-white border border-slate-600">Reset</button>
          <button onClick={finish} className="ml-auto px-3 py-2 rounded bg-slate-700 text-white border border-slate-600">Finish</button>
        </div>

        {state.feedback && (
          <div className={`p-3 rounded ${state.feedback.allCorrect ? 'bg-green-500/20 border border-green-500/40 text-green-200' : 'bg-red-500/20 border border-red-500/40 text-red-200'}`}>
            {state.feedback.allCorrect ? 'Excellent! You reconstructed the verse correctly.' : 'Some words are out of place. Incorrect slots are highlighted in red.'}
          </div>
        )}
      </div>
    );
  };

  if (!isLoggedIn) {
    try {
      return (
        <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-800 to-slate-900 p-4">
        <style>{`
          @import url('https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap');
          .sword-drill-title {
            font-family: 'Great Vibes', cursive;
            letter-spacing: 2px;
          }
        `}</style>
        <div className="bg-slate-700 rounded-2xl p-8 max-w-md w-full shadow-2xl border border-amber-500/20">
          <div className="text-center mb-8">
            <div className="text-6xl mb-4">‚öîÔ∏è</div>
            <h1 className="text-5xl font-bold text-amber-400 mb-2 sword-drill-title">Sword Drill</h1>
            <p className="text-amber-200">Gamified Bible Memorization</p>
          </div>
          
          <form onSubmit={isSignUp ? handleSignUp : handleSignIn} className="space-y-4">
            {isSignUp && (
              <input
                type="text"
                placeholder="Full Name"
                value={name}
                onChange={(e) => setName(e.target.value)}
                required
                className="w-full px-4 py-3 rounded-lg bg-slate-800 text-white border border-slate-600 focus:border-amber-500 focus:outline-none"
              />
            )}
            <input
              type="email"
              placeholder="Email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              required
              className="w-full px-4 py-3 rounded-lg bg-slate-800 text-white border border-slate-600 focus:border-amber-500 focus:outline-none"
            />
            <input
              type="password"
              placeholder="Password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              required
              minLength={6}
              className="w-full px-4 py-3 rounded-lg bg-slate-800 text-white border border-slate-600 focus:border-amber-500 focus:outline-none"
            />
            
            {error && (
              <div className="bg-red-500/10 border border-red-500 rounded-lg p-3 text-red-400 text-sm">
                {error}
              </div>
            )}
            
            <button
              type="submit"
              disabled={loading}
              className="w-full bg-gradient-to-r from-amber-500 to-amber-600 text-slate-900 font-bold py-3 rounded-lg hover:from-amber-600 hover:to-amber-700 transition-all disabled:opacity-50"
            >
              {loading ? 'Loading...' : (isSignUp ? 'Create Account' : 'Sign In')}
            </button>
            
            <button
              type="button"
              onClick={() => {
                setIsSignUp(!isSignUp);
                setError('');
              }}
              className="w-full bg-slate-600 text-white font-bold py-3 rounded-lg hover:bg-slate-500 transition-all"
            >
              {isSignUp ? 'Already have an account? Sign In' : 'Need an account? Sign Up'}
            </button>
          </form>
        </div>
      </div>
      );
    } catch (error) {
      console.error('Error rendering login view:', error);
      return (
        <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-800 to-slate-900 p-4">
          <div className="bg-red-900/30 border border-red-700 rounded-xl p-8 max-w-md text-center">
            <p className="text-red-200 mb-4">Error loading login page</p>
            <button
              onClick={() => window.location.reload()}
              className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded"
            >
              Reload
            </button>
          </div>
        </div>
      );
    }
  }

  // Show loading screen if still initializing
  if (!isLoggedIn && !currentUser && !userData) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-800 to-slate-900">
        <div className="text-center">
          <div className="text-6xl mb-4">‚öîÔ∏è</div>
          <h1 className="text-3xl font-bold text-amber-400 mb-4">Sword Drill</h1>
          {initError ? (
            <>
              <p className="text-red-400 mb-4">{initError}</p>
              <p className="text-slate-300 mb-4">Continuing as guest...</p>
            </>
          ) : (
            <>
              <p className="text-slate-300 mb-8">Loading...</p>
              <div className="flex justify-center gap-2">
                <div className="w-3 h-3 bg-amber-400 rounded-full animate-bounce" style={{animationDelay: '0s'}}></div>
                <div className="w-3 h-3 bg-amber-400 rounded-full animate-bounce" style={{animationDelay: '0.1s'}}></div>
                <div className="w-3 h-3 bg-amber-400 rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></div>
              </div>
            </>
          )}
        </div>
      </div>
    );
  }

  try {
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-800 to-slate-900">
      
      {/* Correction Prompt Modal */}
      {correctionPrompt && (
        <div className="fixed inset-0 flex items-center justify-center" style={{ zIndex: 60 }}>
          <div className="absolute inset-0 bg-black/60" onClick={() => { setCorrectionPrompt(null); setCurrentView('home'); setQuizState(null); }}></div>
          <div className="relative z-10 w-full max-w-lg mx-4 bg-slate-800 border border-slate-600 rounded-xl p-5 shadow-2xl">
            <h3 className="text-white font-bold text-lg mb-2">{correctionPrompt.title || 'Review'}</h3>
            <p className="text-slate-300 whitespace-pre-line mb-3">{correctionPrompt.message}</p>
            {correctionPrompt.reference && (
              <div className="text-slate-400 text-xs mb-2">{correctionPrompt.reference}</div>
            )}
            <div className="flex flex-wrap gap-2 mt-2">
              <button
                onClick={() => { (correctionPrompt && correctionPrompt.mode === 'reference') ? beginReferenceReview(correctionPrompt.verseText, correctionPrompt.reference) : beginEnhancedReview(correctionPrompt.verseText, correctionPrompt.reference); setCorrectionPrompt(null); }}
                className="px-3 py-2 rounded bg-amber-500 text-slate-900 font-bold"
              >
                Enhanced Review
              </button>
              <button
                onClick={() => { retryFillBlank(); setCorrectionPrompt(null); }}
                className="px-3 py-2 rounded bg-white/15 text-white border border-white/20"
              >
                Retry Fill-in-the-Blank
              </button>
              <button
                onClick={() => { setCorrectionPrompt(null); setCurrentView('home'); setQuizState(null); }}
                className="px-3 py-2 rounded bg-slate-700 text-white border border-slate-600"
              >
                Close
              </button>
            </div>
          </div>
        </div>
      )}
      <style>{`
  @import url('https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap');
  .sword-drill-title {
    font-family: 'Great Vibes', cursive;
    letter-spacing: 2px;
  }
  .menu-btn {
    width: 100%;
    text-align: left;
    padding: 12px 16px;
    border-radius: 8px;
    background-color: rgba(51, 65, 85, 0.5);
    color: white;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.2s;
    border: none;
    cursor: pointer;
  }
  .menu-btn:hover {
    background-color: rgba(251, 191, 36, 0.1);
    border-color: rgba(251, 191, 36, 0.5);
  }
  @keyframes pulse {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
  }
  .animate-pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }
`}</style>
    {/* Header */}
    <div className="bg-slate-900/80 backdrop-blur border-b border-amber-500/20 sticky top-0 z-10">
      <div className="max-w-2xl mx-auto px-4 py-4 flex items-center justify-between">
        <div className="flex items-center gap-3">
          <div className="text-3xl">‚öîÔ∏è</div>
          <div>
            <h1 className="text-2xl font-bold text-amber-400 sword-drill-title">
              Sword Drill
            </h1>
            <p className="text-xs text-amber-200">Level: Apprentice</p>
          </div>
        </div>
        <button
          onClick={() => setShowMenu(!showMenu)}
          className="text-amber-400 hover:text-amber-300 transition-colors"
        >
          {showMenu ? <X size={28} /> : <Menu size={28} />}
        </button>
      </div>
    </div>

    {/* Menu Drawer */}
    {showMenu && (
      <div
        className="fixed inset-0 bg-black/50 z-20"
        onClick={() => setShowMenu(false)}
      >
        <div
          className="absolute right-0 top-0 h-full w-80 bg-slate-800 border-l border-amber-500/20 p-6 overflow-y-auto"
          onClick={(e) => e.stopPropagation()}
        >
          <div className="flex items-center gap-3 mb-8">
            <User className="text-amber-400" size={32} />
            <div>
              <div className="font-bold text-white">{userData.name}</div>
              <div className="text-sm text-slate-400">
                {userData.totalPoints} points
              </div>
            </div>
          </div>

          <nav className="space-y-2">
            <button
              onClick={() => {
                setCurrentView("home");
                setShowMenu(false);
              }}
              className="menu-btn"
            >
              <Book size={20} /> Home
            </button>

            <button
              onClick={() => {
                setCurrentView("achievements");
                setShowMenu(false);
              }}
              className={`menu-btn ${
                hasUnseenAchievements
                  ? "ring-2 ring-amber-400 ring-offset-2 ring-offset-slate-800 animate-pulse"
                  : ""
              }`}
            >
              <Trophy size={20} />
              <span className="flex-1">Achievements</span>
              {hasUnseenAchievements && (
                <span className="bg-amber-400 text-slate-900 text-xs px-2 py-1 rounded-full font-bold">
                  NEW!
                </span>
              )}
            </button>

            <button
              onClick={() => {
                setCurrentView("mastery");
                setShowMenu(false);
              }}
              className="menu-btn"
            >
              <BarChart size={20} /> Mastery List
            </button>

            <button
              onClick={() => {
                if (!userData.difficultyProgress.Advanced.locked) {
                  setCurrentView("ancient-study");
                  setShowMenu(false);
                } else {
                  alert(
                    "üîí Ancient Study unlocks when you reach Advanced difficulty!\n\nMaster 100 Intermediate verses to unlock."
                  );
                }
              }}
              className={`menu-btn ${
                userData.difficultyProgress.Advanced.locked ? "opacity-50" : ""
              }`}
            >
              <Book size={20} />
              <span className="flex-1">Ancient Study</span>
              {userData.difficultyProgress.Advanced.locked && (
                <span className="text-amber-400">üîí</span>
              )}
            </button>

            <button
              onClick={() => {
                setCurrentView("bibleReader");
                setShowMenu(false);
              }}
              className={`menu-btn ${
                currentView === "bibleReader" ? "text-amber-400" : ""
              }`}
            >
              <Book size={20} />
              <span className="flex-1">Read the Bible</span>
            </button>

            <button
              onClick={() => {
                setCurrentView("help");
                setShowMenu(false);
              }}
              className="menu-btn"
            >
              <HelpCircle size={20} /> Help & Guide
            </button>

            <button
              onClick={() => {
                setCurrentView("settings");
                setShowMenu(false);
              }}
              className="menu-btn"
            >
              <Settings size={20} /> Settings
            </button>

            <button
              onClick={handleSignOut}
              className="menu-btn text-red-400 hover:text-red-300"
            >
              <LogOut size={20} /> Sign Out
            </button>

</nav>
        </div>
      </div>
    )}

    {/* Main Content */}
    <div className="max-w-2xl mx-auto px-4 py-6">
      {currentView === "home" && (
        <>
          <HomeView
            userData={userData}
            verseOfDay={verseOfDay}
            devotionalRead={devotionalRead}
            handleDevotionalRead={handleDevotionalRead}
            getAllDifficultyConfig={getAllDifficultyConfig}
            todaysQuizzesCount={todaysQuizzesCount}
            currentUser={currentUser}
            setShowAnalyticsModal={setShowAnalyticsModal}
            getFlameTier={getFlameTier}
            startQuiz={startQuiz}
            markNewSeen={markNewSeen}
            QUIZ_POINTS={QUIZ_POINTS}
            sharpReload={sharpReload}
            loading={loading}
          />
        </>
      )}

      {currentView === "quiz" && <QuizView />}
      {currentView === "enhanced-review" && <EnhancedReviewView />}
      {currentView === "bibleReader" && <BibleReaderView />}
      {currentView === "achievements" && (
        <AchievementsView
          userData={userData}
          lastSeenAchievementsCount={lastSeenAchievementsCount}
          setHasUnseenAchievements={setHasUnseenAchievements}
        />
      )}
      {currentView === "mastery" && <MasteryView />}
      {currentView === "ancient-study" && <AncientStudyView userData={userData} />}
      {currentView === "help" && <HelpView />}
      {currentView === "settings" && <SettingsView />}
    </div>

    {/* Analytics Modal */}
    <AnalyticsModal 
      isOpen={showAnalyticsModal}
      onClose={() => setShowAnalyticsModal(false)}
      quizHistory={userData.quizHistory || []}
      userData={userData}
    />
    
    {/* S.H.A.R.P. History Modal */}
    {showSharpHistory && (
      <div className="fixed inset-0 z-50 flex items-center justify-center">
        <div
          className="absolute inset-0 bg-black/60"
          onClick={() => setShowSharpHistory(false)}
        />
        <div className="relative z-10 bg-slate-800 border border-slate-700 rounded-xl p-4 w-[90vw] max-w-xl max-h-[80vh] overflow-y-auto">
          <div className="flex items-center justify-between mb-3">
            <h3 className="text-white font-bold">
              S.H.A.R.P. Conversation History
            </h3>
            <div className="flex items-center gap-2">
              <button
                onClick={clearAllSessions}
                className="px-2 py-1 rounded bg-white/10 hover:bg-white/20 text-white text-sm"
              >
                Clear All
              </button>
              <button
                onClick={() => setShowSharpHistory(false)}
                className="px-2 py-1 rounded bg-slate-700 hover:bg-slate-600 text-white text-sm"
              >
                Close
              </button>
            </div>
          </div>

          <div className="space-y-2">
            {(!sharpHistory || sharpHistory.length === 0) && (
              <div className="text-slate-300 text-sm">No saved sessions.</div>
            )}

            {sharpHistory &&
              sharpHistory.map((item) => (
                <div
                  key={item.id}
                  className="p-3 rounded border border-slate-700 bg-slate-900/50"
                >
                  <div className="text-white text-sm font-semibold">
                    Session {item.id}
                  </div>
                  <div className="text-slate-400 text-xs mb-2">
                    {new Date(
                      item?.meta?.startedAt ||
                        item?.meta?.endedAt ||
                        Date.now()
                    ).toLocaleString()}{" "}
                    {'‚Ä¢'} {item?.messages?.length || 0} messages
                  </div>
                  <div className="flex gap-2">
                    <button
                      onClick={() => loadSession(item)}
                      className="px-2 py-1 rounded bg-amber-500/80 hover:bg-amber-500 text-slate-900 text-sm font-semibold"
                    >
                      Load
                    </button>
                    <button
                      onClick={() => deleteSession(item.id)}
                      className="px-2 py-1 rounded bg-white/10 hover:bg-white/20 text-white text-sm"
                    >
                      Delete
                    </button>
                  </div>
                </div>
              ))}
          </div>
        </div>
      </div>
    )}
    </div>
      );
    } catch (error) {
      console.error('Error rendering main view:', error);
      return (
        <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-800 to-slate-900">
          <div className="bg-red-900/30 border border-red-700 rounded-xl p-8 max-w-md text-center">
            <h2 className="text-red-300 text-lg font-bold mb-4">‚ö†Ô∏è Render Error</h2>
            <p className="text-red-200 mb-4 text-sm">{error?.message || 'Error rendering app'}</p>
            <div className="flex gap-2">
              <button
                onClick={() => window.location.reload()}
                className="flex-1 px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded text-sm font-semibold"
              >
                Reload
              </button>
              <button
                onClick={handleSignOut}
                className="flex-1 px-3 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded text-sm font-semibold"
              >
                Sign Out
              </button>
            </div>
          </div>
        </div>
      );
    }
};

export default function AppWithErrorBoundary() {
  return (
    <ErrorBoundary>
      <SwordDrillApp />
    </ErrorBoundary>
  );
}